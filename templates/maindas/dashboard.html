{% extends "dashboard/base.html" %}

{% block content %}
<div class="bg-dark text-light min-vh-100 p-3">
    <div class="mb-3">
        <div class="row g-2">
            <!-- Market Selector -->
            <div class="col-md-2">
                <div class="dropdown">
                    <button class="btn btn-secondary dropdown-toggle w-100" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                        Select Market
                    </button>
                    <ul class="dropdown-menu dropdown-menu-dark">
                        <li><a class="dropdown-item active" href="#">All Markets</a></li>
                        <li><a class="dropdown-item" href="#">Technology</a></li>
                        <li><a class="dropdown-item" href="#">Consumer Cyclical</a></li>
                        <li><a class="dropdown-item" href="#">Healthcare</a></li>
                        <li><a class="dropdown-item" href="#">Financial</a></li>
                        <li><a class="dropdown-item" href="#">Energy</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#">Top Gainers</a></li>
                        <li><a class="dropdown-item" href="#">Top Losers</a></li>
                    </ul>
                </div>
            </div>
            
            <!-- Time Period -->
            <div class="col-md-2">
                <div class="dropdown">
                    <button class="btn btn-outline-secondary dropdown-toggle w-100" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                        Time Period
                    </button>
                    <ul class="dropdown-menu dropdown-menu-dark">
                        <li><a class="dropdown-item" href="#">1 Day</a></li>
                        <li><a class="dropdown-item" href="#">1 Week</a></li>
                        <li><a class="dropdown-item active" href="#">1 Month</a></li>
                        <li><a class="dropdown-item" href="#">3 Months</a></li>
                        <li><a class="dropdown-item" href="#">6 Months</a></li>
                        <li><a class="dropdown-item" href="#">1 Year</a></li>
                        <li><a class="dropdown-item" href="#">5 Years</a></li>
                    </ul>
                </div>
            </div>
            
            <!-- Sort By -->
            <div class="col-md-2">
                <div class="dropdown">
                    <button class="btn btn-outline-secondary dropdown-toggle w-100" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                        Sort By
                    </button>
                    <ul class="dropdown-menu dropdown-menu-dark">
                        <li><a class="dropdown-item" href="#">Symbol</a></li>
                        <li><a class="dropdown-item" href="#">Price (High to Low)</a></li>
                        <li><a class="dropdown-item" href="#">Price (Low to High)</a></li>
                        <li><a class="dropdown-item active" href="#">Change %</a></li>
                        <li><a class="dropdown-item" href="#">Volume</a></li>
                        <li><a class="dropdown-item" href="#">Market Cap</a></li>
                        <li><a class="dropdown-item" href="#">P/E Ratio</a></li>
                    </ul>
                </div>
            </div>
            
            <!-- View Type -->
            <div class="col-md-2">
                <div class="dropdown">
                    <button class="btn btn-outline-secondary dropdown-toggle w-100" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                        View
                    </button>
                    <ul class="dropdown-menu dropdown-menu-dark">
                        <li><a class="dropdown-item active" href="#">Table View</a></li>
                        <li><a class="dropdown-item" href="#">Grid View</a></li>
                        <li><a class="dropdown-item" href="#">Chart View</a></li>
                        <li><a class="dropdown-item" href="#">Compact View</a></li>
                    </ul>
                </div>
            </div>
            
            <!-- Results Per Page -->
            <div class="col-md-2">
                <div class="dropdown">
                    <button class="btn btn-outline-secondary dropdown-toggle w-100" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                        Show
                    </button>
                    <ul class="dropdown-menu dropdown-menu-dark">
                        <li><a class="dropdown-item" href="#">10 results</a></li>
                        <li><a class="dropdown-item active" href="#">25 results</a></li>
                        <li><a class="dropdown-item" href="#">50 results</a></li>
                        <li><a class="dropdown-item" href="#">100 results</a></li>
                        <li><a class="dropdown-item" href="#">All results</a></li>
                    </ul>
                </div>
            </div>
            
            <!-- Column Visibility Button -->
            <div class="col-md-1">
                <button class="btn btn-outline-info w-100" type="button" data-bs-toggle="modal" data-bs-target="#columnVisibilityModal" title="Manage Columns">
                    <i class="fas fa-columns"></i>
                </button>
            </div>
            
            <!-- Filter Button -->
            <div class="col-md-1">
                <button class="btn btn-success w-100" type="button" title="Apply Filters">
                    <i class="fas fa-filter"></i>
                </button>
            </div>
        </div>
    </div>
    
    <div class="table-responsive">
        <table class="table table-dark table-bordered" id="indicatorTable">
            <thead>
                <tr>
                    <th class="position-sticky start-0 bg-dark" data-column="0">Symbol</th>
                    <th draggable="true" data-column="1" class="draggable-header">EMA <button class="btn btn-sm btn-outline-light ms-1" type="button" style="font-size: 10px; padding: 1px 4px;" title="Configure EMA">+</button><button class="btn btn-sm btn-outline-danger ms-1" type="button" style="font-size: 10px; padding: 1px 4px;" title="Hide Column" onclick="hideColumn(1)">×</button></th>
                    <th draggable="true" data-column="2" class="draggable-header">SMA <button class="btn btn-sm btn-outline-light ms-1" type="button" style="font-size: 10px; padding: 1px 4px;" title="Configure SMA">+</button><button class="btn btn-sm btn-outline-danger ms-1" type="button" style="font-size: 10px; padding: 1px 4px;" title="Hide Column" onclick="hideColumn(2)">×</button></th>
                    <th draggable="true" data-column="3" class="draggable-header">HMA <button class="btn btn-sm btn-outline-light ms-1" type="button" style="font-size: 10px; padding: 1px 4px;" title="Configure HMA">+</button><button class="btn btn-sm btn-outline-danger ms-1" type="button" style="font-size: 10px; padding: 1px 4px;" title="Hide Column" onclick="hideColumn(3)">×</button></th>
                    <th draggable="true" data-column="4" class="draggable-header">MACD <button class="btn btn-sm btn-outline-light ms-1" type="button" style="font-size: 10px; padding: 1px 4px;" title="Configure MACD">+</button><button class="btn btn-sm btn-outline-danger ms-1" type="button" style="font-size: 10px; padding: 1px 4px;" title="Hide Column" onclick="hideColumn(4)">×</button></th>
                    <th draggable="true" data-column="5" class="draggable-header">Signal Line <button class="btn btn-sm btn-outline-danger ms-1" type="button" style="font-size: 10px; padding: 1px 4px;" title="Hide Column" onclick="hideColumn(5)">×</button></th>
                    <th draggable="true" data-column="6" class="draggable-header">Supertrend <button class="btn btn-sm btn-outline-light ms-1" type="button" style="font-size: 10px; padding: 1px 4px;" title="Configure Supertrend">+</button><button class="btn btn-sm btn-outline-danger ms-1" type="button" style="font-size: 10px; padding: 1px 4px;" title="Hide Column" onclick="hideColumn(6)">×</button></th>
                    <th draggable="true" data-column="7" class="draggable-header">AO <button class="btn btn-sm btn-outline-light ms-1" type="button" style="font-size: 10px; padding: 1px 4px;" title="Configure Awesome Oscillator">+</button><button class="btn btn-sm btn-outline-danger ms-1" type="button" style="font-size: 10px; padding: 1px 4px;" title="Hide Column" onclick="hideColumn(7)">×</button></th>
                    <th draggable="true" data-column="8" class="draggable-header">Keltner Upper <button class="btn btn-sm btn-outline-light ms-1" type="button" style="font-size: 10px; padding: 1px 4px;" title="Configure Keltner Channels">+</button><button class="btn btn-sm btn-outline-danger ms-1" type="button" style="font-size: 10px; padding: 1px 4px;" title="Hide Column" onclick="hideColumn(8)">×</button></th>
                    <th draggable="true" data-column="9" class="draggable-header">Keltner Middle <button class="btn btn-sm btn-outline-light ms-1" type="button" style="font-size: 10px; padding: 1px 4px;" title="Configure Keltner Channels">+</button><button class="btn btn-sm btn-outline-danger ms-1" type="button" style="font-size: 10px; padding: 1px 4px;" title="Hide Column" onclick="hideColumn(9)">×</button></th>
                    <th draggable="true" data-column="10" class="draggable-header">Keltner Lower <button class="btn btn-sm btn-outline-light ms-1" type="button" style="font-size: 10px; padding: 1px 4px;" title="Configure Keltner Channels">+</button><button class="btn btn-sm btn-outline-danger ms-1" type="button" style="font-size: 10px; padding: 1px 4px;" title="Hide Column" onclick="hideColumn(10)">×</button></th>
                    <th draggable="true" data-column="11" class="draggable-header">Pivot <button class="btn btn-sm btn-outline-danger ms-1" type="button" style="font-size: 10px; padding: 1px 4px;" title="Hide Column" onclick="hideColumn(11)">×</button></th>
                    <th draggable="true" data-column="12" class="draggable-header">R1 <button class="btn btn-sm btn-outline-danger ms-1" type="button" style="font-size: 10px; padding: 1px 4px;" title="Hide Column" onclick="hideColumn(12)">×</button></th>
                    <th draggable="true" data-column="13" class="draggable-header">S1 <button class="btn btn-sm btn-outline-danger ms-1" type="button" style="font-size: 10px; padding: 1px 4px;" title="Hide Column" onclick="hideColumn(13)">×</button></th>
                    <th draggable="true" data-column="14" class="draggable-header">R2 <button class="btn btn-sm btn-outline-danger ms-1" type="button" style="font-size: 10px; padding: 1px 4px;" title="Hide Column" onclick="hideColumn(14)">×</button></th>
                    <th draggable="true" data-column="15" class="draggable-header">S2 <button class="btn btn-sm btn-outline-danger ms-1" type="button" style="font-size: 10px; padding: 1px 4px;" title="Hide Column" onclick="hideColumn(15)">×</button></th>
                    <th draggable="true" data-column="16" class="draggable-header">R3 <button class="btn btn-sm btn-outline-danger ms-1" type="button" style="font-size: 10px; padding: 1px 4px;" title="Hide Column" onclick="hideColumn(16)">×</button></th>
                    <th draggable="true" data-column="17" class="draggable-header">S3 <button class="btn btn-sm btn-outline-danger ms-1" type="button" style="font-size: 10px; padding: 1px 4px;" title="Hide Column" onclick="hideColumn(17)">×</button></th>
                    <th draggable="true" data-column="18" class="draggable-header">Camarilla R1 <button class="btn btn-sm btn-outline-danger ms-1" type="button" style="font-size: 10px; padding: 1px 4px;" title="Hide Column" onclick="hideColumn(18)">×</button></th>
                    <th draggable="true" data-column="19" class="draggable-header">Camarilla R2 <button class="btn btn-sm btn-outline-danger ms-1" type="button" style="font-size: 10px; padding: 1px 4px;" title="Hide Column" onclick="hideColumn(19)">×</button></th>
                    <th draggable="true" data-column="20" class="draggable-header">Camarilla R3 <button class="btn btn-sm btn-outline-danger ms-1" type="button" style="font-size: 10px; padding: 1px 4px;" title="Hide Column" onclick="hideColumn(20)">×</button></th>
                    <th draggable="true" data-column="21" class="draggable-header">Camarilla R4 <button class="btn btn-sm btn-outline-danger ms-1" type="button" style="font-size: 10px; padding: 1px 4px;" title="Hide Column" onclick="hideColumn(21)">×</button></th>
                    <th draggable="true" data-column="22" class="draggable-header">Camarilla S1 <button class="btn btn-sm btn-outline-danger ms-1" type="button" style="font-size: 10px; padding: 1px 4px;" title="Hide Column" onclick="hideColumn(22)">×</button></th>
                    <th draggable="true" data-column="23" class="draggable-header">Camarilla S2 <button class="btn btn-sm btn-outline-danger ms-1" type="button" style="font-size: 10px; padding: 1px 4px;" title="Hide Column" onclick="hideColumn(23)">×</button></th>
                    <th draggable="true" data-column="24" class="draggable-header">Camarilla S3 <button class="btn btn-sm btn-outline-danger ms-1" type="button" style="font-size: 10px; padding: 1px 4px;" title="Hide Column" onclick="hideColumn(24)">×</button></th>
                    <th draggable="true" data-column="25" class="draggable-header">Camarilla S4 <button class="btn btn-sm btn-outline-danger ms-1" type="button" style="font-size: 10px; padding: 1px 4px;" title="Hide Column" onclick="hideColumn(25)">×</button></th>
                    <th draggable="true" data-column="26" class="draggable-header">Bias <button class="btn btn-sm btn-outline-danger ms-1" type="button" style="font-size: 10px; padding: 1px 4px;" title="Hide Column" onclick="hideColumn(26)">×</button></th>
                </tr>
            </thead>
            <tbody id="tableBody">
                <tr>
                    <td colspan="27" class="text-center">
                        <div class="spinner-border text-light" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <div class="mt-2">Connecting to live data stream...</div>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- Status Information -->
    <div class="row mt-3">
        <div class="col-md-6">
            <small class="text-muted">
                <i class="fas fa-signal"></i> Live Data Status: <span id="connectionStatus" class="text-warning">Connecting...</span>
            </small>
        </div>
        <div class="col-md-6 text-end">
            <small class="text-muted">
                Last Updated: <span id="lastUpdated">-</span>
            </small>
        </div>
    </div>

    <!-- Indicator Configuration Modal -->
    <div class="modal fade" id="indicatorModal" tabindex="-1" aria-labelledby="indicatorModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content bg-dark">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title text-light" id="indicatorModalLabel">Configure Indicator</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="indicatorValue" class="form-label text-light" id="indicatorLabel">Value</label>
                        <input type="number" class="form-control bg-dark text-light border-secondary" id="indicatorValue" placeholder="Enter value">
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveIndicator">Update</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MACD Configuration Modal -->
    <div class="modal fade" id="macdModal" tabindex="-1" aria-labelledby="macdModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content bg-dark">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title text-light" id="macdModalLabel">Configure MACD</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="macdFast" class="form-label text-light">Fast Period</label>
                        <input type="number" class="form-control bg-dark text-light border-secondary" id="macdFast" value="12">
                    </div>
                    <div class="mb-3">
                        <label for="macdSlow" class="form-label text-light">Slow Period</label>
                        <input type="number" class="form-control bg-dark text-light border-secondary" id="macdSlow" value="26">
                    </div>
                    <div class="mb-3">
                        <label for="macdSignal" class="form-label text-light">Signal Period</label>
                        <input type="number" class="form-control bg-dark text-light border-secondary" id="macdSignal" value="9">
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveMacd">Update MACD</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Supertrend Configuration Modal -->
    <div class="modal fade" id="supertrendModal" tabindex="-1" aria-labelledby="supertrendModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content bg-dark">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title text-light" id="supertrendModalLabel">Configure Supertrend</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="supertrendLength" class="form-label text-light">Length</label>
                        <input type="number" class="form-control bg-dark text-light border-secondary" id="supertrendLength" value="14">
                    </div>
                    <div class="mb-3">
                        <label for="supertrendMultiplier" class="form-label text-light">Multiplier</label>
                        <input type="number" class="form-control bg-dark text-light border-secondary" id="supertrendMultiplier" value="3" step="0.1">
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveSupertrend">Update Supertrend</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Keltner Channels Configuration Modal -->
    <div class="modal fade" id="keltnerModal" tabindex="-1" aria-labelledby="keltnerModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content bg-dark">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title text-light" id="keltnerModalLabel">Configure Keltner Channels</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="keltnerEmaLength" class="form-label text-light">EMA Length</label>
                        <input type="number" class="form-control bg-dark text-light border-secondary" id="keltnerEmaLength" value="20">
                    </div>
                    <div class="mb-3">
                        <label for="keltnerAtrLength" class="form-label text-light">ATR Length</label>
                        <input type="number" class="form-control bg-dark text-light border-secondary" id="keltnerAtrLength" value="14">
                    </div>
                    <div class="mb-3">
                        <label for="keltnerMultiplier" class="form-label text-light">Multiplier</label>
                        <input type="number" class="form-control bg-dark text-light border-secondary" id="keltnerMultiplier" value="2" step="0.1">
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-warning" id="resetKeltner">Reset Defaults</button>
                    <button type="button" class="btn btn-primary" id="saveKeltner">Update Keltner</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Column Visibility Modal -->
    <div class="modal fade" id="columnVisibilityModal" tabindex="-1" aria-labelledby="columnVisibilityModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content bg-dark">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title text-light" id="columnVisibilityModalLabel">
                        <i class="fas fa-columns me-2"></i>Manage Column Visibility
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-light mb-3">Technical Indicators</h6>
                            <div id="technicalColumns" class="column-group">
                                <!-- Technical indicator checkboxes will be added here -->
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-light mb-3">Support & Resistance</h6>
                            <div id="pivotColumns" class="column-group">
                                <!-- Pivot and resistance/support checkboxes will be added here -->
                            </div>
                        </div>
                    </div>
                    <hr class="border-secondary">
                    <div class="row">
                        <div class="col-12">
                            <small class="text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                Use the checkboxes to show/hide columns. You can also click the "×" button on any column header to hide it quickly.
                            </small>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-outline-warning" id="showAllColumns">Show All</button>
                    <button type="button" class="btn btn-outline-danger" id="hideAllOptional">Hide All Optional</button>
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <style>
        .draggable-header {
            cursor: grab;
            user-select: none;
            position: relative;
        }
        
        .draggable-header:active {
            cursor: grabbing;
        }
        
        .draggable-header:hover {
            background-color: rgba(255, 255, 255, 0.1) !important;
        }
        
        .drag-over {
            background-color: rgba(0, 123, 255, 0.4) !important;
            border-left: 4px solid #007bff !important;
            border-right: 4px solid #007bff !important;
            transition: all 0.2s ease;
        }
        
        .dragging {
            opacity: 0.6;
            background-color: rgba(255, 255, 255, 0.2) !important;
            transform: rotate(3deg);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            z-index: 1000;
        }
        
        /* Add a grab handle indicator */
        .draggable-header::before {
            content: '⋮⋮';
            position: absolute;
            left: 2px;
            top: 50%;
            transform: translateY(-50%);
            color: rgba(255, 255, 255, 0.3);
            font-size: 12px;
            letter-spacing: -2px;
        }
        
        .draggable-header:hover::before {
            color: rgba(255, 255, 255, 0.6);
        }

        /* Column visibility modal styles */
        .column-group {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .form-check-input:checked {
            background-color: #0d6efd;
            border-color: #0d6efd;
        }
        
        .form-check-input:focus {
            border-color: #86b7fe;
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        }
        
        .form-check-label {
            cursor: pointer;
        }
        
        .form-check {
            padding-left: 1.5em;
        }
    </style>

    <script>
        let eventSource;
        let isConnected = false;
        const tableBody = document.getElementById('tableBody');
        const connectionStatus = document.getElementById('connectionStatus');
        const lastUpdated = document.getElementById('lastUpdated');
        let disconnectTimeout;
        const DISCONNECT_DELAY = 5000; // 5 seconds

        // Current indicator configurations
        let currentConfig = {
            timeframe: '1',
            ema: '10',
            sma: '10', 
            hma: '10',
            macd: '26,12,9',
            supertrendLength: '14',
            supertrendMultiplier: '3',
            keltnerEmaLength: '20',
            keltnerAtrLength: '14',
            keltnerMultiplier: '2'
        };

        let currentIndicator = '';
        let currentIndicatorType = '';
        let draggedColumn = null;
        let columnOrder = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26];
        
        // Column visibility state - all visible by default
        let columnVisibility = {
            0: true,  // Symbol - always visible
            1: true,  // EMA
            2: true,  // SMA
            3: true,  // HMA
            4: true,  // MACD
            5: true,  // Signal Line
            6: true,  // Supertrend
            7: true,  // AO
            8: true,  // Keltner Upper
            9: true,  // Keltner Middle
            10: true, // Keltner Lower
            11: true, // Pivot
            12: true, // R1
            13: true, // S1
            14: true, // R2
            15: true, // S2
            16: true, // R3
            17: true, // S3
            18: true, // Camarilla R1
            19: true, // Camarilla R2
            20: true, // Camarilla R3
            21: true, // Camarilla R4
            22: true, // Camarilla S1
            23: true, // Camarilla S2
            24: true, // Camarilla S3
            25: true, // Camarilla S4
            26: true  // Bias
        };
        
        // Define the original data field mapping
        const dataFieldMapping = {
            0: 'ticker_symbol',
            1: 'ema',
            2: 'sma', 
            3: 'hma',
            4: 'macd',
            5: 'signal_line',
            6: 'supertrend',
            7: 'ao',
            8: 'keltner_upper',
            9: 'keltner_middle',
            10: 'keltner_lower',
            11: 'pivot',
            12: 'r1',
            13: 's1',
            14: 'r2',
            15: 's2',
            16: 'r3',
            17: 's3',
            18: 'camarilla_r1',
            19: 'camarilla_r2',
            20: 'camarilla_r3',
            21: 'camarilla_r4',
            22: 'camarilla_s1',
            23: 'camarilla_s2',
            24: 'camarilla_s3',
            25: 'camarilla_s4',
            26: 'bias'
        };

        // Column names for display
        const columnNames = {
            0: 'Symbol',
            1: 'EMA',
            2: 'SMA',
            3: 'HMA',
            4: 'MACD',
            5: 'Signal Line',
            6: 'Supertrend',
            7: 'AO',
            8: 'Keltner Upper',
            9: 'Keltner Middle',
            10: 'Keltner Lower',
            11: 'Pivot',
            12: 'R1',
            13: 'S1',
            14: 'R2',
            15: 'S2',
            16: 'R3',
            17: 'S3',
            18: 'Camarilla R1',
            19: 'Camarilla R2',
            20: 'Camarilla R3',
            21: 'Camarilla R4',
            22: 'Camarilla S1',
            23: 'Camarilla S2',
            24: 'Camarilla S3',
            25: 'Camarilla S4',
            26: 'Bias'
        };

        function updateConnectionStatus(status, text) {
            connectionStatus.textContent = text;
            connectionStatus.className = status === 'connected' ? 'text-success' : 
                                        status === 'error' ? 'text-danger' : 'text-warning';
        }

        function updateLastUpdatedTime() {
            const now = new Date();
            lastUpdated.textContent = now.toLocaleTimeString();
        }

        // Event handlers for + buttons
        function setupIndicatorButtons() {
            // Add event listeners to all + buttons
            document.addEventListener('click', function(e) {
                if (e.target.textContent === '+' && e.target.tagName === 'BUTTON') {
                    e.stopPropagation(); // Prevent any parent event handling
                    
                    const th = e.target.closest('th');
                    const indicatorName = th.textContent.replace('+', '').trim();
                    
                    // Handle different indicators
                    if (indicatorName === 'EMA') {
                        openIndicatorModal('EMA', 'ema', currentConfig.ema);
                    } else if (indicatorName === 'SMA') {
                        openIndicatorModal('SMA', 'sma', currentConfig.sma);
                    } else if (indicatorName === 'HMA') {
                        openIndicatorModal('HMA', 'hma', currentConfig.hma);
                    } else if (indicatorName === 'MACD') {
                        openMacdModal();
                    } else if (indicatorName === 'Supertrend') {
                        openSupertrendModal();
                    } else if (indicatorName.includes('Keltner')) {
                        openKeltnerModal();
                    } else {
                        // For other indicators, show general modal
                        openIndicatorModal(indicatorName, 'general', '');
                    }
                }
            });
            
            // Prevent dragging when clicking on + buttons
            document.addEventListener('mousedown', function(e) {
                if (e.target.textContent === '+' && e.target.tagName === 'BUTTON') {
                    const th = e.target.closest('th');
                    if (th) {
                        th.setAttribute('draggable', 'false');
                    }
                }
            });
            
            document.addEventListener('mouseup', function(e) {
                // Re-enable dragging for all headers
                const headers = document.querySelectorAll('.draggable-header');
                headers.forEach(header => {
                    header.setAttribute('draggable', 'true');
                });
            });
        }

        function openIndicatorModal(name, type, value) {
            currentIndicator = name;
            currentIndicatorType = type;
            document.getElementById('indicatorModalLabel').textContent = `Configure ${name}`;
            document.getElementById('indicatorLabel').textContent = `${name} Period`;
            document.getElementById('indicatorValue').value = value;
            new bootstrap.Modal(document.getElementById('indicatorModal')).show();
        }

        function openMacdModal() {
            const parts = currentConfig.macd.split(',');
            document.getElementById('macdSlow').value = parts[0] || '26';
            document.getElementById('macdFast').value = parts[1] || '12';
            document.getElementById('macdSignal').value = parts[2] || '9';
            new bootstrap.Modal(document.getElementById('macdModal')).show();
        }

        function openSupertrendModal() {
            document.getElementById('supertrendLength').value = currentConfig.supertrendLength;
            document.getElementById('supertrendMultiplier').value = currentConfig.supertrendMultiplier;
            new bootstrap.Modal(document.getElementById('supertrendModal')).show();
        }

        function openKeltnerModal() {
            document.getElementById('keltnerEmaLength').value = currentConfig.keltnerEmaLength;
            document.getElementById('keltnerAtrLength').value = currentConfig.keltnerAtrLength;
            document.getElementById('keltnerMultiplier').value = currentConfig.keltnerMultiplier;
            new bootstrap.Modal(document.getElementById('keltnerModal')).show();
        }

        // Save button handlers
        function setupModalSaveHandlers() {
            // General indicator save
            document.getElementById('saveIndicator').addEventListener('click', function() {
                const value = document.getElementById('indicatorValue').value;
                if (currentIndicatorType && value) {
                    currentConfig[currentIndicatorType] = value;
                    console.log(`Updated ${currentIndicator} to ${value}`);
                    reconnectWithNewConfig();
                }
                bootstrap.Modal.getInstance(document.getElementById('indicatorModal')).hide();
            });

            // MACD save
            document.getElementById('saveMacd').addEventListener('click', function() {
                const slow = document.getElementById('macdSlow').value;
                const fast = document.getElementById('macdFast').value;
                const signal = document.getElementById('macdSignal').value;
                currentConfig.macd = `${slow},${fast},${signal}`;
                console.log(`Updated MACD to ${currentConfig.macd}`);
                reconnectWithNewConfig();
                bootstrap.Modal.getInstance(document.getElementById('macdModal')).hide();
            });

            // Supertrend save
            document.getElementById('saveSupertrend').addEventListener('click', function() {
                currentConfig.supertrendLength = document.getElementById('supertrendLength').value;
                currentConfig.supertrendMultiplier = document.getElementById('supertrendMultiplier').value;
                console.log(`Updated Supertrend to Length: ${currentConfig.supertrendLength}, Multiplier: ${currentConfig.supertrendMultiplier}`);
                reconnectWithNewConfig();
                bootstrap.Modal.getInstance(document.getElementById('supertrendModal')).hide();
            });

            // Keltner save
            document.getElementById('saveKeltner').addEventListener('click', function() {
                currentConfig.keltnerEmaLength = document.getElementById('keltnerEmaLength').value;
                currentConfig.keltnerAtrLength = document.getElementById('keltnerAtrLength').value;
                currentConfig.keltnerMultiplier = document.getElementById('keltnerMultiplier').value;
                console.log(`Updated Keltner to EMA: ${currentConfig.keltnerEmaLength}, ATR: ${currentConfig.keltnerAtrLength}, Multiplier: ${currentConfig.keltnerMultiplier}`);
                reconnectWithNewConfig();
                bootstrap.Modal.getInstance(document.getElementById('keltnerModal')).hide();
            });

            // Keltner reset
            document.getElementById('resetKeltner').addEventListener('click', function() {
                document.getElementById('keltnerEmaLength').value = '20';
                document.getElementById('keltnerAtrLength').value = '14';
                document.getElementById('keltnerMultiplier').value = '2';
            });
        }

        function reconnectWithNewConfig() {
            console.log('Reconnecting with new configuration:', currentConfig);
            createEventSource();
        }

        // Drag and Drop Functions
        function setupDragAndDrop() {
            const headers = document.querySelectorAll('.draggable-header');
            
            headers.forEach(header => {
                // Remove existing listeners to prevent duplicates
                header.removeEventListener('dragstart', handleDragStart);
                header.removeEventListener('dragover', handleDragOver);
                header.removeEventListener('dragenter', handleDragEnter);
                header.removeEventListener('dragleave', handleDragLeave);
                header.removeEventListener('drop', handleDrop);
                header.removeEventListener('dragend', handleDragEnd);
                
                // Add event listeners
                header.addEventListener('dragstart', handleDragStart);
                header.addEventListener('dragover', handleDragOver);
                header.addEventListener('dragenter', handleDragEnter);
                header.addEventListener('dragleave', handleDragLeave);
                header.addEventListener('drop', handleDrop);
                header.addEventListener('dragend', handleDragEnd);
            });
        }

        function handleDragStart(e) {
            // Find the th element even if the target is a child element (like + button)
            const th = e.target.closest('th');
            if (!th) return;
            
            draggedColumn = parseInt(th.getAttribute('data-column'));
            th.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', th.outerHTML);
            
            console.log('Drag started for column:', draggedColumn);
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        function handleDragEnter(e) {
            const th = e.target.closest('th');
            if (!th) return;
            
            const targetColumn = parseInt(th.getAttribute('data-column'));
            if (targetColumn !== 0 && targetColumn !== draggedColumn) { // Don't allow dropping on Symbol column
                th.classList.add('drag-over');
                console.log('Drag enter on column:', targetColumn);
            }
        }

        function handleDragLeave(e) {
            const th = e.target.closest('th');
            if (th) {
                th.classList.remove('drag-over');
            }
        }

        function handleDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const th = e.target.closest('th');
            if (!th) return false;
            
            const targetColumn = parseInt(th.getAttribute('data-column'));
            
            // Don't allow dropping on Symbol column (index 0)
            if (targetColumn === 0 || draggedColumn === 0) {
                console.log('Drop not allowed on Symbol column');
                return false;
            }
            
            if (draggedColumn !== targetColumn) {
                console.log('Dropping column', draggedColumn, 'onto', targetColumn);
                
                // Find the actual position indices in the DOM
                const headerRow = document.querySelector('thead tr');
                const headers = Array.from(headerRow.children);
                
                let fromIndex = -1;
                let toIndex = -1;
                
                headers.forEach((header, index) => {
                    const colIndex = parseInt(header.getAttribute('data-column'));
                    if (colIndex === draggedColumn) fromIndex = index;
                    if (colIndex === targetColumn) toIndex = index;
                });
                
                if (fromIndex !== -1 && toIndex !== -1) {
                    reorderColumns(fromIndex, toIndex);
                }
            }
            
            return false;
        }

        function handleDragEnd(e) {
            const headers = document.querySelectorAll('th');
            headers.forEach(header => {
                header.classList.remove('dragging', 'drag-over');
            });
            draggedColumn = null;
            console.log('Drag ended');
        }

        function reorderColumns(fromIndex, toIndex) {
            const table = document.getElementById('indicatorTable');
            const headerRow = table.querySelector('thead tr');
            const headers = Array.from(headerRow.children);
            
            // Get the original data-column values before moving
            const fromOriginalColumn = parseInt(headers[fromIndex].getAttribute('data-column'));
            const toOriginalColumn = parseInt(headers[toIndex].getAttribute('data-column'));
            
            // Move header
            const draggedHeader = headers[fromIndex];
            const targetHeader = headers[toIndex];
            
            if (fromIndex < toIndex) {
                headerRow.insertBefore(draggedHeader, targetHeader.nextSibling);
            } else {
                headerRow.insertBefore(draggedHeader, targetHeader);
            }
            
            // Move data cells in all rows
            const dataRows = table.querySelectorAll('tbody tr');
            dataRows.forEach(row => {
                const cells = Array.from(row.children);
                const draggedCell = cells[fromIndex];
                const targetCell = cells[toIndex];
                
                if (draggedCell && targetCell) {
                    if (fromIndex < toIndex) {
                        row.insertBefore(draggedCell, targetCell.nextSibling);
                    } else {
                        row.insertBefore(draggedCell, targetCell);
                    }
                }
            });
            
            // Update column order tracking - track the original data-column values
            const newColumnOrder = [];
            const updatedHeaders = Array.from(headerRow.children);
            updatedHeaders.forEach(header => {
                newColumnOrder.push(parseInt(header.getAttribute('data-column')));
            });
            columnOrder = newColumnOrder;
            
            // Update data-column attributes to match new positions
            updateColumnAttributes();
            
            console.log('Columns reordered. New order:', columnOrder);
        }

        function updateColumnAttributes() {
            // Re-setup drag and drop for updated elements
            setupDragAndDrop();
            
            console.log('Column attributes updated and drag-drop re-initialized');
        }

        // Column Visibility Functions
        function hideColumn(columnIndex) {
            if (columnIndex === 0) {
                alert('Cannot hide the Symbol column');
                return;
            }
            
            columnVisibility[columnIndex] = false;
            updateTableVisibility();
            updateColumnVisibilityModal();
            console.log('Hidden column:', columnIndex);
        }

        function showColumn(columnIndex) {
            columnVisibility[columnIndex] = true;
            updateTableVisibility();
            updateColumnVisibilityModal();
            console.log('Shown column:', columnIndex);
        }

        function updateTableVisibility() {
            // Hide/show header columns
            const headers = document.querySelectorAll('thead th');
            headers.forEach(header => {
                const columnIndex = parseInt(header.getAttribute('data-column'));
                if (columnVisibility[columnIndex]) {
                    header.style.display = '';
                } else {
                    header.style.display = 'none';
                }
            });

            // Clear the table body - next SSE data update will recreate with correct columns
            tableBody.innerHTML = `
                <tr>
                    <td colspan="${Object.values(columnVisibility).filter(visible => visible).length}" class="text-center">
                        <div class="spinner-border text-light spinner-border-sm" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <div class="mt-2">Updating column layout...</div>
                    </td>
                </tr>
            `;
            
            console.log('Column visibility updated, waiting for next data update');
        }

        function setupColumnVisibilityModal() {
            const technicalColumns = document.getElementById('technicalColumns');
            const pivotColumns = document.getElementById('pivotColumns');
            
            // Clear existing content
            technicalColumns.innerHTML = '';
            pivotColumns.innerHTML = '';
            
            // Technical indicators (1-10)
            const technicalIndices = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10];
            technicalIndices.forEach(index => {
                const checkbox = createColumnCheckbox(index);
                technicalColumns.appendChild(checkbox);
            });
            
            // Pivot points and support/resistance (11-26)
            const pivotIndices = [11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26];
            pivotIndices.forEach(index => {
                const checkbox = createColumnCheckbox(index);
                pivotColumns.appendChild(checkbox);
            });
            
            // Setup modal buttons
            document.getElementById('showAllColumns').addEventListener('click', showAllColumns);
            document.getElementById('hideAllOptional').addEventListener('click', hideAllOptionalColumns);
        }

        function createColumnCheckbox(columnIndex) {
            const div = document.createElement('div');
            div.className = 'form-check mb-2';
            
            const checkbox = document.createElement('input');
            checkbox.className = 'form-check-input';
            checkbox.type = 'checkbox';
            checkbox.id = `column-${columnIndex}`;
            checkbox.checked = columnVisibility[columnIndex];
            checkbox.addEventListener('change', function() {
                if (this.checked) {
                    showColumn(columnIndex);
                } else {
                    hideColumn(columnIndex);
                }
            });
            
            const label = document.createElement('label');
            label.className = 'form-check-label text-light';
            label.setAttribute('for', `column-${columnIndex}`);
            label.textContent = columnNames[columnIndex];
            
            div.appendChild(checkbox);
            div.appendChild(label);
            
            return div;
        }

        function updateColumnVisibilityModal() {
            Object.keys(columnVisibility).forEach(columnIndex => {
                const checkbox = document.getElementById(`column-${columnIndex}`);
                if (checkbox) {
                    checkbox.checked = columnVisibility[columnIndex];
                }
            });
        }

        function showAllColumns() {
            Object.keys(columnVisibility).forEach(index => {
                columnVisibility[index] = true;
            });
            updateTableVisibility();
            updateColumnVisibilityModal();
            console.log('All columns shown');
        }

        function hideAllOptionalColumns() {
            // Hide all except Symbol (0), EMA (1), SMA (2), MACD (4), Supertrend (6)
            const essentialColumns = [0, 1, 2, 4, 6];
            Object.keys(columnVisibility).forEach(index => {
                columnVisibility[index] = essentialColumns.includes(parseInt(index));
            });
            updateTableVisibility();
            updateColumnVisibilityModal();
            console.log('Hidden all optional columns');
        }

        // Make hideColumn available globally for onclick handlers
        window.hideColumn = hideColumn;

        function createEventSource() {
            if (eventSource) {
                eventSource.close();
            }

            // Set status to connecting as soon as we try to connect
            updateConnectionStatus('connecting', 'Connecting...');

            // Clear any previous disconnect timer
            if (disconnectTimeout) clearTimeout(disconnectTimeout);

            const queryParams = new URLSearchParams({
                data_types: 'indicators',
                timeframe: currentConfig.timeframe,
                ema: currentConfig.ema,
                sma: currentConfig.sma,
                hma: currentConfig.hma,
                macd: currentConfig.macd,
                supertrendLength: currentConfig.supertrendLength,
                supertrendMultiplier: currentConfig.supertrendMultiplier,
                keltnerEmaLength: currentConfig.keltnerEmaLength,
                keltnerAtrLength: currentConfig.keltnerAtrLength,
                keltnerMultiplier: currentConfig.keltnerMultiplier
            });

            console.log('Connecting to unified SSE stream with parameters:', queryParams.toString());
            eventSource = new EventSource(`{% url "unified_sse_stream" %}?${queryParams.toString()}`);

            eventSource.onopen = function() {
                console.log('SSE connection opened');
                isConnected = true;
                updateConnectionStatus('connected', 'Connected');
            };

            eventSource.onerror = function(error) {
                console.error('SSE connection error:', error);
                isConnected = false;
                updateConnectionStatus('connecting', 'Connecting...');
                // Auto-reconnect after 5 seconds
                setTimeout(() => {
                    if (!isConnected) {
                        console.log('Attempting to reconnect...');
                        createEventSource();
                    }
                }, 5000);
            };

            eventSource.onmessage = function(event) {
                try {
                    const response = JSON.parse(event.data);
                    console.log('Received unified stream response:', response);
                    
                    // Handle different message types from unified stream
                    if (response.type === 'indicators') {
                        console.log('Processing indicators data:', response.data);
                        console.log('Processing time:', response.processing_time, 'seconds');
                        updateTable(response.data);
                        updateLastUpdatedTime();
                        // On every message, reset disconnect timer
                        if (disconnectTimeout) clearTimeout(disconnectTimeout);
                        updateConnectionStatus('connected', 'Connected');
                        disconnectTimeout = setTimeout(function() {
                            updateConnectionStatus('error', 'Disconnected');
                        }, DISCONNECT_DELAY);
                    } else if (response.type === 'error') {
                        console.error('Error from unified stream:', response.error);
                        updateConnectionStatus('error', `Error: ${response.error}`);
                    } else {
                        console.log('Received other data type:', response.type);
                        // Ignore other data types (dynamic, static) since we only requested indicators
                    }
                } catch (error) {
                    console.error('Error parsing unified SSE data:', error);
                }
            };
        }

                function updateTable(data) {
            // Clear existing rows
            tableBody.innerHTML = '';

            // Count visible columns for colspan
            const visibleColumnCount = Object.values(columnVisibility).filter(visible => visible).length;

            if (data.message) {
                tableBody.innerHTML = `<tr><td colspan="${visibleColumnCount}" class="text-center text-warning">${data.message}</td></tr>`;
                return;
            }

            if (!Array.isArray(data) || data.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="${visibleColumnCount}" class="text-center text-muted">No data available</td></tr>`;
                return;
            }

            data.forEach(ticker => {
                const row = document.createElement('tr');
                
                // Get all headers and filter for visible ones
                const headers = document.querySelectorAll('thead th');
                const visibleHeaders = Array.from(headers).filter(header => {
                    const columnIndex = parseInt(header.getAttribute('data-column'));
                    return columnVisibility[columnIndex];
                });
                
                visibleHeaders.forEach((header, position) => {
                    const originalColumnIndex = parseInt(header.getAttribute('data-column'));
                    const fieldName = dataFieldMapping[originalColumnIndex];
                    const cell = document.createElement('td');
                    
                    // Handle Symbol column (always first visually but may be at different data-column)
                    if (originalColumnIndex === 0) {
                        cell.className = 'position-sticky start-0 bg-dark fw-bold';
                        cell.textContent = ticker[fieldName] || '-';
                    } else {
                        const value = ticker[fieldName];
                        
                        if (typeof value === 'number') {
                            cell.textContent = value.toFixed(2);
                            
                            // Add color coding based on field name, not index
                            if (fieldName === 'signal_line') {
                                cell.className = value > 0 ? 'text-success' : 'text-danger';
                            } else if (fieldName === 'ao') {
                                cell.className = value > 0 ? 'text-success' : 'text-danger';
                            }
                        } else {
                            cell.textContent = value || '-';
                            
                            // Special handling for bias column
                            if (fieldName === 'bias') {
                                if (value === 'BULLISH') {
                                    cell.className = 'text-success fw-bold';
                                } else if (value === 'BEARISH') {
                                    cell.className = 'text-danger fw-bold';
                                } else {
                                    cell.className = 'text-warning';
                                }
                            }
                        }
                    }
                    
                    row.appendChild(cell);
                });

                tableBody.appendChild(row);
            });
            
            console.log(`Table updated with ${visibleColumnCount} visible columns`);
        }

        // Initialize connection when page loads
        document.addEventListener('DOMContentLoaded', function() {
            setupIndicatorButtons();
            setupModalSaveHandlers();
            setupDragAndDrop();
            setupColumnVisibilityModal();
            createEventSource();
        });

        // Handle page visibility changes to manage connection
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                console.log('Page hidden, maintaining connection');
            } else {
                console.log('Page visible');
                if (!isConnected) {
                    createEventSource();
                }
            }
        });

        // Clean up connection when page unloads
        window.addEventListener('beforeunload', function() {
            if (eventSource) {
                eventSource.close();
            }
        });
    </script>
</div>
{% endblock %}
