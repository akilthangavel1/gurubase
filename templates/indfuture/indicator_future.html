<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Future Dynamic Data</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            background-color: #121212;
            color: #e0e0e0;
            padding: 20px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .header {
            margin-bottom: 25px;
            background-color: #1e1e1e;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }
        
        h1 {
            font-weight: 600;
            margin-bottom: 15px;
            color: #00b7ff;
        }
        
        .control-panel {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
            background-color: #1e1e1e;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .control-group label {
            font-size: 0.85rem;
            color: #00b7ff;
        }
        
        select, input, button {
            background-color: #333;
            color: white;
            border: 1px solid #444;
            border-radius: 4px;
            padding: 5px 10px;
        }
        
        button {
            background-color: #0062cc;
            transition: background-color 0.2s;
            border: none;
            padding: 8px 16px;
            cursor: pointer;
            margin-top: auto;
        }
        
        button:hover {
            background-color: #0069d9;
        }
        
        .table-container {
            overflow-x: auto;
            margin-top: 20px;
            background-color: #1e1e1e;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            padding: 5px;
        }
        
        .table-dark {
            background-color: transparent;
            color: #e0e0e0;
            margin-bottom: 0;
        }
        
        .table-dark th {
            background-color: #000000;
            color: #00b7ff;
            padding: 12px 8px;
            font-weight: 600;
            font-size: 0.9rem;
            text-transform: uppercase;
            border-bottom: 2px solid #333;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .table-dark td {
            padding: 8px;
            border-color: #333;
            vertical-align: middle;
        }
        
        tr:nth-child(odd) {
            background-color: rgba(255, 255, 255, 0.05);
        }
        
        tr:hover {
            background-color: rgba(0, 183, 255, 0.1);
        }
        
        td.positive { color: #4caf50 !important; }
        td.negative { color: #f44336 !important; }
        td.neutral { color: #e0e0e0 !important; }
        
        .ticker-cell {
            font-weight: bold;
            color: #fff;
        }
        
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }
        
        .status-indicator.bullish { background-color: #4caf50; }
        .status-indicator.bearish { background-color: #f44336; }
        .status-indicator.neutral { background-color: #9e9e9e; }
        
        .loading-indicator {
            text-align: center;
            padding: 20px;
            color: #00b7ff;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1><i class="fas fa-chart-line"></i> Indicator Dynamic Data</h1>
    </div>

    <div class="control-panel">
        <div class="control-group">
            <label for="timeframe"><i class="fas fa-clock"></i> Timeframe</label>
            <select id="timeframe" class="form-select">
                <option value="1">1 Minute</option>
                <option value="5">5 Minutes</option>
                <option value="15">15 Minutes</option>
                <option value="30">30 Minutes</option>
                <option value="60">1 Hour</option>
                <option value="240">4 Hours</option>
                <option value="1440">1 Day</option>
            </select>
        </div>

        <div class="control-group">
            <label for="emaValue"><i class="fas fa-wave-square"></i> EMA</label>
            <input type="number" id="emaValue" class="form-control" step="0.01" placeholder="EMA value">
        </div>
        
        <div class="control-group">
            <label for="smaValue"><i class="fas fa-chart-line"></i> SMA</label>
            <input type="number" id="smaValue" class="form-control" step="0.01" placeholder="SMA value">
        </div>
        
        <div class="control-group">
            <label for="hmaValue"><i class="fas fa-chart-area"></i> HMA</label>
            <input type="number" id="hmaValue" class="form-control" step="0.01" placeholder="HMA value">
        </div>
        
        <div class="control-group">
            <label for="macdValue"><i class="fas fa-signal"></i> MACD</label>
            <input type="text" id="macdValue" class="form-control" step="0.01" placeholder="MACD value">
        </div>
        
        <div class="control-group">
            <label for="supertrendLength"><i class="fas fa-ruler-horizontal"></i> Supertrend Length</label>
            <input type="number" id="supertrendLength" class="form-control" placeholder="Length" value="14">
        </div>
        
        <div class="control-group">
            <label for="supertrendMultiplier"><i class="fas fa-sliders-h"></i> Supertrend Multiplier</label>
            <input type="number" id="supertrendMultiplier" class="form-control" placeholder="Multiplier" value="3">
        </div>
        
        <div class="control-group">
            <label>&nbsp;</label>
            <button id="updateIndicators" class="btn btn-primary">
                <i class="fas fa-sync-alt"></i> Update
            </button>
        </div>
    </div>

    <div id="data-container">
        <div class="table-container">
            <table class="table table-dark table-bordered text-center" id="dynamicDataTable">
                <thead> 
                    <tr>
                        <th>Ticker</th>
                        <th>EMA</th>
                        <th>SMA</th>
                        <th>HMA</th>
                        <th>MACD</th>
                        <th>Signal Line</th>
                        <th>SUPERTREND</th>
                        <th>AO</th>
                        <th>Keltner Upper</th>
                        <th>Keltner Middle</th>
                        <th>Keltner Lower</th>
                        <th>Pivot</th>
                        <th>R1</th>
                        <th>S1</th>
                        <th>R2</th>
                        <th>S2</th>
                        <th>R3</th>
                        <th>S3</th>
                        <th>Camarilla R1</th>
                        <th>Camarilla R2</th>
                        <th>Camarilla R3</th>
                        <th>Camarilla R4</th>
                        <th>Camarilla S1</th>
                        <th>Camarilla S2</th>
                        <th>Camarilla S3</th>
                        <th>Camarilla S4</th>
                        <th>BIAS</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="27" class="loading-indicator">
                            <i class="fas fa-spinner fa-spin"></i> Loading data...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        const dataContainer = document.getElementById('data-container');
        const timeframeSelect = document.getElementById('timeframe');
        const updateButton = document.getElementById('updateIndicators');

        let eventSource;

        function createEventSource(timeframe, ema, sma, hma, macd, supertrendLength, supertrendMultiplier) {
            if (eventSource) {
                eventSource.close();
            }
            
            // Show loading indicator
            const tableBody = document.querySelector('#dynamicDataTable tbody');
            tableBody.innerHTML = `<tr><td colspan="27" class="loading-indicator"><i class="fas fa-spinner fa-spin"></i> Loading data...</td></tr>`;
            
            const newEventSource = new EventSource(`{% url "stream_indicator_data" %}?timeframe=${timeframe}&ema=${ema}&sma=${sma}&hma=${hma}&macd=${macd}&supertrendLength=${supertrendLength}&supertrendMultiplier=${supertrendMultiplier}`);
            
            newEventSource.onopen = () => console.log('EventSource connection opened with timeframe:', timeframe);
            
            newEventSource.onerror = (error) => {
                console.error('EventSource error:', error);
                tableBody.innerHTML = `<tr><td colspan="27" class="text-danger"><i class="fas fa-exclamation-triangle"></i> Error connecting to the server. Please try again later.</td></tr>`;
            };
            
            newEventSource.onmessage = function(event) {
                const data = JSON.parse(event.data);
                const tableBody = document.querySelector('#dynamicDataTable tbody');

                while (tableBody.firstChild) {
                    tableBody.removeChild(tableBody.firstChild);
                }

                if (data.message) {
                    tableBody.innerHTML = `<tr><td colspan="27">${data.message}</td></tr>`;
                } else {
                    data.forEach(ticker => {
                        const row = document.createElement('tr');
                        
                        // Add ticker symbol with bias indicator
                        const tickerCell = document.createElement('td');
                        tickerCell.classList.add('ticker-cell');
                        
                        let biasIndicator = '';
                        if (ticker.bias === 'Bullish') {
                            biasIndicator = '<span class="status-indicator bullish"></span>';
                        } else if (ticker.bias === 'Bearish') {
                            biasIndicator = '<span class="status-indicator bearish"></span>';
                        } else {
                            biasIndicator = '<span class="status-indicator neutral"></span>';
                        }
                        
                        tickerCell.innerHTML = `${biasIndicator}${ticker.ticker_symbol}`;
                        row.appendChild(tickerCell);
                        
                        // Add other values
                        const values = [
                            ticker.ema, ticker.sma, ticker.hma, ticker.macd, ticker.signal_line, 
                            ticker.supertrend, ticker.ao, ticker.kc_upper, ticker.kc_middle, 
                            ticker.kc_lower, ticker.pivot, ticker.r1, ticker.s1, ticker.r2, 
                            ticker.s2, ticker.r3, ticker.s3, ticker.camarilla_r1, ticker.camarilla_r2, 
                            ticker.camarilla_r3, ticker.camarilla_r4, ticker.camarilla_s1, 
                            ticker.camarilla_s2, ticker.camarilla_s3, ticker.camarilla_s4, ticker.bias
                        ];
                        
                        values.forEach((value, index) => {
                            const cell = document.createElement('td');
                            
                            // Format numbers
                            if (typeof value === 'number') {
                                const formattedValue = value.toFixed(2);
                                cell.textContent = formattedValue;
                                
                                // Color positive/negative values
                                if (value > 0) {
                                    cell.classList.add('positive');
                                } else if (value < 0) {
                                    cell.classList.add('negative');
                                } else {
                                    cell.classList.add('neutral');
                                }
                            } 
                            // Format bias with color
                            else if (index === values.length - 1) {
                                cell.textContent = value;
                                if (value === 'Bullish') {
                                    cell.classList.add('positive');
                                } else if (value === 'Bearish') {
                                    cell.classList.add('negative');
                                } else {
                                    cell.classList.add('neutral');
                                }
                            } 
                            // Other values
                            else {
                                cell.textContent = value || '-';
                            }
                            
                            row.appendChild(cell);
                        });
                        
                        tableBody.appendChild(row);
                    });
                }
            };
            return newEventSource;
        }

        // Initialize EventSource with default indicator values
        const defaultEMA = document.getElementById('emaValue').value || 0;
        const defaultSMA = document.getElementById('smaValue').value || 0;
        const defaultHMA = document.getElementById('hmaValue').value || 0;
        const defaultMACD = document.getElementById('macdValue').value || 0;
        const defaultSupertrendLength = document.getElementById('supertrendLength').value || 14;
        const defaultSupertrendMultiplier = document.getElementById('supertrendMultiplier').value || 3;
        eventSource = createEventSource(timeframeSelect.value, defaultEMA, defaultSMA, defaultHMA, defaultMACD, defaultSupertrendLength, defaultSupertrendMultiplier);

        // Update EventSource when indicators change
        updateButton.addEventListener('click', function() {
            const ema = document.getElementById('emaValue').value || 0;
            const sma = document.getElementById('smaValue').value || 0;
            const hma = document.getElementById('hmaValue').value || 0;
            const macd = document.getElementById('macdValue').value || 0;
            const supertrendLength = document.getElementById('supertrendLength').value || 14;
            const supertrendMultiplier = document.getElementById('supertrendMultiplier').value || 3;
            const emaValue = ema === 0 ? 10 : ema;  // Default EMA to 10 if 0
            
            console.log('Update Indicators button clicked');
            console.log(`Connecting with: timeframe=${timeframeSelect.value}, EMA=${emaValue}, SMA=${sma}, HMA=${hma}, MACD=${macd}, Supertrend Length=${supertrendLength}, Supertrend Multiplier=${supertrendMultiplier}`);
            
            eventSource = createEventSource(timeframeSelect.value, emaValue, sma, hma, macd, supertrendLength, supertrendMultiplier);
        });
    </script>
</body>
</html>