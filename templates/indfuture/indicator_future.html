<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Future Dynamic Data</title>
    <style>
        body {
            background-color: #1a1a1a;
            color: #ffffff;
            margin: 0;
            font-family: Arial, sans-serif;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
        }
        .timeframe-selector {
            background-color: #2d2d2d;
            padding: 15px;
            border-radius: 8px;
        }
        .timeframe-selector label {
            font-weight: bold;
            margin-right: 10px;
            color: #ffffff;
        }
        .timeframe-selector select {
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #404040;
            background-color: #333333;
            color: #ffffff;
        }
        .timeframe-selector select:focus {
            outline: none;
            border-color: #0066cc;
        }
        #updateTimeframe {
            margin-left: 10px;
            padding: 8px 15px;
            border-radius: 5px;
            border: none;
            background-color: #0066cc;
            color: white;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        #updateTimeframe:hover {
            background-color: #0052a3;
        }
        h1 {
            color: #ffffff;
            margin: 0;
        }
        .table-responsive {
            width: 100%;
            overflow-x: auto;
            margin: 20px;
        }
        .table {
            width: 100%;
            border-collapse: collapse;
            background-color: #1a1a1a;
            color: #ffffff;
            border: 1px solid #333;
        }
        .table th, .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #404040;
        }
        .table th {
            background-color: #2d2d2d;
            font-weight: bold;
        }
        .table tbody tr:nth-child(odd) {
            background-color: #262626;
        }
        .table tbody tr:hover {
            background-color: #333333;
        }
        .text-success {
            color: #ffffff !important;
        }
        .text-danger {
            color: #ff4d4d !important;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Indicator Dynamic Data</h1>
        <div class="timeframe-selector">
            <label for="timeframe">Select Timeframe:</label>
            <select id="timeframe">
                <option value="1">1 Minute</option>
                <option value="5">5 Minutes</option>
                <option value="15">15 Minutes</option>
                <option value="30">30 Minutes</option>
                <option value="60">1 Hour</option>
                <option value="240">4 Hours</option>
                <option value="1440">1 Day</option>
            </select>
            <button id="updateTimeframe">Update</button>
        </div>
    </div>

    <div id="data-container">
        <div class="table-responsive">
            <table class="table table-striped table-hover" id="dynamicDataTable">
                <thead>
                    <tr>
                        <th>Ticker</th>
                        <th>EMA</th>
                        <th>SMA</th>
                        <th>HMA</th>
                        <th>MACD</th>
                        <th>Signal Line</th>
                        <th>SUPERTREND</th>
                        <th>AO</th>
                        <th>Keltner Upper</th>
                        <th>Keltner Middle</th>
                        <th>Keltner Lower</th>
                        <th>Pivot</th>
                        <th>R1</th>
                        <th>S1</th>
                        <th>R2</th>
                        <th>S2</th>
                        <th>R3</th>
                        <th>S3</th>
                        <th>Camarilla R1</th>
                        <th>Camarilla R2</th>
                        <th>Camarilla R3</th>
                        <th>Camarilla R4</th>
                        <th>Camarilla S1</th>
                        <th>Camarilla S2</th>
                        <th>Camarilla S3</th>
                        <th>Camarilla S4</th>
                        <th>BIAS</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Data will be populated via JavaScript -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        const dataContainer = document.getElementById('data-container');
        const timeframeSelect = document.getElementById('timeframe');
        const updateButton = document.getElementById('updateTimeframe');

        let eventSource;

        function createEventSource(timeframe) {
            if (eventSource) {
                console.log('Closing existing EventSource');
                eventSource.close();
            }
            console.log('Creating new EventSource with timeframe:', timeframe);
            const newEventSource = new EventSource(`{% url "stream_indicator_data" %}?timeframe=${timeframe}`);
            
            newEventSource.onopen = () => console.log('EventSource connection opened with timeframe:', timeframe);
            
            newEventSource.onerror = (error) => {
                console.error('EventSource error:', error);
                dataContainer.innerHTML = '<p>Error connecting to the server. Please try again later.</p>';
            };
            
            newEventSource.onmessage = function(event) {
                const data = JSON.parse(event.data);
                const tableBody = document.querySelector('#dynamicDataTable tbody');

                while (tableBody.firstChild) {
                    tableBody.removeChild(tableBody.firstChild);
                }

                if (data.message) {
                    dataContainer.innerHTML = `<p>${data.message}</p>`;
                } else {
                    data.forEach(ticker => {
                        const row = document.createElement('tr');
                        const values = [
                            ticker.ticker_symbol, ticker.ema, ticker.sma, ticker.hma, ticker.macd, ticker.signal_line, ticker.supertrend, ticker.ao, ticker.kc_upper, ticker.kc_middle, ticker.kc_lower, ticker.pivot, ticker.r1, ticker.s1, ticker.r2, ticker.s2, ticker.r3, ticker.s3, ticker.camarilla_r1, ticker.camarilla_r2, ticker.camarilla_r3, ticker.camarilla_r4, ticker.camarilla_s1, ticker.camarilla_s2, ticker.camarilla_s3, ticker.camarilla_s4, ticker.bias
                        ];
                        values.forEach((value, index) => {
                            const cell = document.createElement('td');
                            if (typeof value === 'number') {
                                const formattedValue = value.toFixed(2);
                                if (value > 0) {
                                    cell.innerHTML = `<span class="text-success">${formattedValue}</span>`;
                                } else if (value < 0) {
                                    cell.innerHTML = `<span class="text-danger">${formattedValue}</span>`;
                                } else {
                                    cell.textContent = formattedValue;
                                }
                            } else if (index === values.length - 1) { // Bias column
                                cell.textContent = value;
                                if (value === 'BULLISH') {
                                    cell.className = 'text-success';
                                } else if (value === 'BEARISH') {
                                    cell.className = 'text-danger';
                                }
                            } else {
                                cell.textContent = value || '-';
                            }
                            row.appendChild(cell);
                        });
                        tableBody.appendChild(row);
                    });
                }
            };
            return newEventSource;
        }

        // Initialize EventSource
        eventSource = createEventSource(timeframeSelect.value);

        // Update EventSource when timeframe changes
        updateButton.addEventListener('click', function() {
            eventSource = createEventSource(timeframeSelect.value);
        });
    </script>
</body>
</html>