{% extends "dashboard/base.html" %}

{% block content %}
<div class="bg-dark text-light min-vh-100 p-3">
    <div class="mb-3">
        <div class="row g-2">
            <!-- Market Selector -->
            <div class="col-md-2">
                <div class="dropdown">
                    <button class="btn btn-secondary dropdown-toggle w-100" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                        Select Market
                    </button>
                    <ul class="dropdown-menu dropdown-menu-dark">
                        <li><a class="dropdown-item active" href="#">All Markets</a></li>
                        <li><a class="dropdown-item" href="#">Technology</a></li>
                        <li><a class="dropdown-item" href="#">Consumer Cyclical</a></li>x
                        <li><a class="dropdown-item" href="#">Healthcare</a></li>
                        <li><a class="dropdown-item" href="#">Financial</a></li>
                        <li><a class="dropdown-item" href="#">Energy</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#">Top Gainers</a></li>
                        <li><a class="dropdown-item" href="#">Top Losers</a></li>
                    </ul>
                </div>
            </div>
            
            <!-- Time Period -->
            <div class="col-md-2">
                <div class="dropdown">
                    <button class="btn btn-outline-secondary dropdown-toggle w-100" type="button" data-bs-toggle="dropdown" aria-expanded="false" id="timeframeButton">
                        1 Minute
                    </button>
                    <ul class="dropdown-menu dropdown-menu-dark" id="timeframeDropdown">
                        <li><a class="dropdown-item timeframe-option active" href="#" data-timeframe="1" data-display="1 Minute">1 Minute</a></li>
                        <li><a class="dropdown-item timeframe-option" href="#" data-timeframe="5" data-display="5 Minutes">5 Minutes</a></li>
                        <li><a class="dropdown-item timeframe-option" href="#" data-timeframe="10" data-display="10 Minutes">10 Minutes</a></li>
                        <li><a class="dropdown-item timeframe-option" href="#" data-timeframe="15" data-display="15 Minutes">15 Minutes</a></li>
                        <li><a class="dropdown-item timeframe-option" href="#" data-timeframe="30" data-display="30 Minutes">30 Minutes</a></li>
                        <li><a class="dropdown-item timeframe-option" href="#" data-timeframe="45" data-display="45 Minutes">45 Minutes</a></li>
                        <li><a class="dropdown-item timeframe-option" href="#" data-timeframe="60" data-display="1 Hour">1 Hour</a></li>
                        <li><a class="dropdown-item timeframe-option" href="#" data-timeframe="120" data-display="2 Hours">2 Hours</a></li>
                        <li><a class="dropdown-item timeframe-option" href="#" data-timeframe="240" data-display="4 Hours">4 Hours</a></li>
                        <li><a class="dropdown-item timeframe-option" href="#" data-timeframe="1440" data-display="1 Day">1 Day</a></li>
                    </ul>
                </div>
            </div>
            
            <!-- Sort By -->
            <div class="col-md-2">
                <div class="dropdown">
                    <button class="btn btn-outline-secondary dropdown-toggle w-100" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                        Sort By
                    </button>
                    <ul class="dropdown-menu dropdown-menu-dark">
                        <li><a class="dropdown-item" href="#">Symbol</a></li>
                        <li><a class="dropdown-item" href="#">Price (High to Low)</a></li>
                        <li><a class="dropdown-item" href="#">Price (Low to High)</a></li>
                        <li><a class="dropdown-item active" href="#">Change %</a></li>
                        <li><a class="dropdown-item" href="#">Volume</a></li>
                        <li><a class="dropdown-item" href="#">Market Cap</a></li>
                        <li><a class="dropdown-item" href="#">P/E Ratio</a></li>
                    </ul>
                </div>
            </div>
            
            <!-- View Type -->
            <div class="col-md-2">
                <div class="dropdown">
                    <button class="btn btn-outline-secondary dropdown-toggle w-100" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                        View
                    </button>
                    <ul class="dropdown-menu dropdown-menu-dark">
                        <li><a class="dropdown-item active" href="#">Table View</a></li>
                        <li><a class="dropdown-item" href="#">Grid View</a></li>
                        <li><a class="dropdown-item" href="#">Chart View</a></li>
                        <li><a class="dropdown-item" href="#">Compact View</a></li>
                    </ul>
                </div>
            </div>
            
            <!-- Results Per Page -->
            <div class="col-md-2">
                <div class="dropdown">
                    <button class="btn btn-outline-secondary dropdown-toggle w-100" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                        Show
                    </button>
                    <ul class="dropdown-menu dropdown-menu-dark">
                        <li><a class="dropdown-item" href="#">10 results</a></li>
                        <li><a class="dropdown-item active" href="#">25 results</a></li>
                        <li><a class="dropdown-item" href="#">50 results</a></li>
                        <li><a class="dropdown-item" href="#">100 results</a></li>
                        <li><a class="dropdown-item" href="#">All results</a></li>
                    </ul>
                </div>
            </div>
            
            <!-- Column Visibility Button -->
            <div class="col-md-1">
                <button class="btn btn-outline-info w-100" type="button" data-bs-toggle="modal" data-bs-target="#columnVisibilityModal" title="Manage Columns">
                    <i class="fas fa-columns"></i>
                </button>
            </div>
            
            <!-- Filter Button -->
            <div class="col-md-1">
                <button class="btn btn-success w-100" type="button" title="Apply Filters">
                    <i class="fas fa-filter"></i>
                </button>
            </div>
        </div>
    </div>
    
    <div class="table-responsive">
        <table class="table table-dark table-bordered" id="indicatorTable">
            <thead>
                <tr id="tableHeader">
                    <!-- Table headers will be dynamically generated -->
                </tr>
            </thead>
            <tbody id="tableBody">
                <tr>
                    <td colspan="1" class="text-center">
                        <div class="spinner-border text-light" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <div class="mt-2">Connecting to live data stream...</div>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- Status Information -->
    <div class="row mt-3">
        <div class="col-md-6">
            <small class="text-muted">
                <i class="fas fa-signal"></i> Live Data Status: <span id="connectionStatus" class="text-warning">Connecting...</span>
            </small>
        </div>
        <div class="col-md-6 text-end">
            <small class="text-muted">
                Last Updated: <span id="lastUpdated">-</span>
            </small>
        </div>
    </div>

    <!-- Indicator Configuration Modal -->
    <div class="modal fade" id="indicatorModal" tabindex="-1" aria-labelledby="indicatorModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content bg-dark">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title text-light" id="indicatorModalLabel">Configure Indicator</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="indicatorValue" class="form-label text-light" id="indicatorLabel">Value</label>
                        <input type="number" class="form-control bg-dark text-light border-secondary" id="indicatorValue" placeholder="Enter value">
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveIndicator">Update</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MACD Configuration Modal -->
    <div class="modal fade" id="macdModal" tabindex="-1" aria-labelledby="macdModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content bg-dark">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title text-light" id="macdModalLabel">Configure MACD</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="macdFast" class="form-label text-light">Fast Period</label>
                        <input type="number" class="form-control bg-dark text-light border-secondary" id="macdFast" value="12">
                    </div>
                    <div class="mb-3">
                        <label for="macdSlow" class="form-label text-light">Slow Period</label>
                        <input type="number" class="form-control bg-dark text-light border-secondary" id="macdSlow" value="26">
                    </div>
                    <div class="mb-3">
                        <label for="macdSignal" class="form-label text-light">Signal Period</label>
                        <input type="number" class="form-control bg-dark text-light border-secondary" id="macdSignal" value="9">
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveMacd">Update MACD</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Supertrend Configuration Modal -->
    <div class="modal fade" id="supertrendModal" tabindex="-1" aria-labelledby="supertrendModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content bg-dark">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title text-light" id="supertrendModalLabel">Configure Supertrend</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="supertrendLength" class="form-label text-light">Length</label>
                        <input type="number" class="form-control bg-dark text-light border-secondary" id="supertrendLength" value="14">
                    </div>
                    <div class="mb-3">
                        <label for="supertrendMultiplier" class="form-label text-light">Multiplier</label>
                        <input type="number" class="form-control bg-dark text-light border-secondary" id="supertrendMultiplier" value="3" step="0.1">
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveSupertrend">Update Supertrend</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Keltner Channels Configuration Modal -->
    <div class="modal fade" id="keltnerModal" tabindex="-1" aria-labelledby="keltnerModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content bg-dark">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title text-light" id="keltnerModalLabel">Configure Keltner Channels</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="keltnerEmaLength" class="form-label text-light">EMA Length</label>
                        <input type="number" class="form-control bg-dark text-light border-secondary" id="keltnerEmaLength" value="20">
                    </div>
                    <div class="mb-3">
                        <label for="keltnerAtrLength" class="form-label text-light">ATR Length</label>
                        <input type="number" class="form-control bg-dark text-light border-secondary" id="keltnerAtrLength" value="14">
                    </div>
                    <div class="mb-3">
                        <label for="keltnerMultiplier" class="form-label text-light">Multiplier</label>
                        <input type="number" class="form-control bg-dark text-light border-secondary" id="keltnerMultiplier" value="2" step="0.1">
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-warning" id="resetKeltner">Reset Defaults</button>
                    <button type="button" class="btn btn-primary" id="saveKeltner">Update Keltner</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Column Visibility Modal -->
    <div class="modal fade" id="columnVisibilityModal" tabindex="-1" aria-labelledby="columnVisibilityModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content bg-dark">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title text-light" id="columnVisibilityModalLabel">
                        <i class="fas fa-columns me-2"></i>Manage Column Visibility
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-light mb-3">Dynamic & Technical Indicators</h6>
                            <div id="technicalColumns" class="column-group">
                                <!-- Technical indicator and dynamic data checkboxes will be added here -->
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-light mb-3">Static Data & Historical Analysis</h6>
                            <div id="pivotColumns" class="column-group">
                                <!-- Static data, support/resistance, and historical analysis checkboxes will be added here -->
                            </div>
                        </div>
                    </div>
                    <hr class="border-secondary">
                    <div class="row">
                        <div class="col-12">
                            <small class="text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                Comprehensive data includes dynamic OHLC data, technical indicators, hourly/daily/weekly/monthly analysis, swing points, support/resistance levels, and statistical aggregates. Use checkboxes to show/hide columns or click "×" on column headers for quick hiding.
                            </small>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-outline-warning" id="showAllColumns">Show All</button>
                    <button type="button" class="btn btn-outline-danger" id="hideAllOptional">Hide All Optional</button>
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <style>
        .draggable-header {
            cursor: grab;
            user-select: none;
            position: relative;
        }
        
        .draggable-header:active {
            cursor: grabbing;
        }
        
        .draggable-header:hover {
            background-color: rgba(255, 255, 255, 0.1) !important;
        }
        
        .drag-over {
            background-color: rgba(0, 123, 255, 0.4) !important;
            border-left: 4px solid #007bff !important;
            border-right: 4px solid #007bff !important;
            transition: all 0.2s ease;
        }
        
        .dragging {
            opacity: 0.6;
            background-color: rgba(255, 255, 255, 0.2) !important;
            transform: rotate(3deg);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            z-index: 1000;
        }
        
        /* Add a grab handle indicator */
        .draggable-header::before {
            content: '⋮⋮';
            position: absolute;
            left: 2px;
            top: 50%;
            transform: translateY(-50%);
            color: rgba(255, 255, 255, 0.3);
            font-size: 12px;
            letter-spacing: -2px;
        }
        
        .draggable-header:hover::before {
            color: rgba(255, 255, 255, 0.6);
        }

        /* Column visibility modal styles */
        .column-group {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .form-check-input:checked {
            background-color: #0d6efd;
            border-color: #0d6efd;
        }
        
        .form-check-input:focus {
            border-color: #86b7fe;
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        }
        
        .form-check-label {
            cursor: pointer;
        }
        
        .form-check {
            padding-left: 1.5em;
        }
    </style>

    <script>
        let eventSource;
        let isConnected = false;
        const tableBody = document.getElementById('tableBody');
        const connectionStatus = document.getElementById('connectionStatus');
        const lastUpdated = document.getElementById('lastUpdated');
        let disconnectTimeout;
        const DISCONNECT_DELAY = 5000; // 5 seconds

        // Current indicator configurations
        let currentConfig = {
            timeframe: '1',
            ema: '10',
            sma: '10', 
            hma: '10',
            macd: '26,12,9',
            supertrendLength: '14',
            supertrendMultiplier: '3',
            keltnerEmaLength: '20',
            keltnerAtrLength: '14',
            keltnerMultiplier: '2'
        };

        let currentIndicator = '';
        let currentIndicatorType = '';
        let draggedColumn = null;
        
        // Store data from different streams
        let latestData = {
            dynamic: {},
            static: {},
            indicators: {}
        };
        
        // Combined data for display
        let combinedData = [];
        
        // Column visibility state - start with essential columns visible
        let columnVisibility = {};
        
        // Track current column order (will be updated by drag and drop)
        let currentColumnOrder = [];
        
        // Initialize column visibility - show essential columns by default
        function initializeColumnVisibility() {
            // Essential columns that should be visible by default
            const essentialColumns = [
                'ticker_symbol', 'current_candle_close', 'bias', 'ema', 'sma', 'macd', 'supertrend',
                'pivot', 'r1', 's1'
            ];
            
            Object.keys(allAvailableFields).forEach((fieldName, index) => {
                columnVisibility[index] = essentialColumns.includes(fieldName);
            });
            
            // Initialize column order to match the original field names order
            currentColumnOrder = [...fieldNames];
        }

        // Generate table headers dynamically based on current column order
        function generateTableHeaders() {
            const headerRow = document.getElementById('tableHeader');
            headerRow.innerHTML = '';
            
            currentColumnOrder.forEach((fieldName, visualIndex) => {
                const originalIndex = fieldNameToIndex[fieldName];
                const th = document.createElement('th');
                th.setAttribute('data-column', visualIndex);
                th.setAttribute('data-field', fieldName);
                th.setAttribute('data-original-index', originalIndex);
                
                if (fieldName === 'ticker_symbol') {
                    th.className = 'position-sticky start-0 bg-dark';
                } else {
                    th.className = 'draggable-header';
                    th.setAttribute('draggable', 'true');
                }
                
                const displayName = allAvailableFields[fieldName];
                th.innerHTML = displayName;
                
                // Add configuration button for configurable indicators
                const configurableFields = ['ema', 'sma', 'hma', 'macd', 'supertrend', 'keltner_upper', 'keltner_middle', 'keltner_lower', 'ao'];
                if (configurableFields.includes(fieldName)) {
                    th.innerHTML += ` <button class="btn btn-sm btn-outline-light ms-1" type="button" style="font-size: 10px; padding: 1px 4px;" title="Configure ${displayName}">+</button>`;
                }
                
                // Add hide button for all non-symbol columns
                if (fieldName !== 'ticker_symbol') {
                    th.innerHTML += ` <button class="btn btn-sm btn-outline-danger ms-1" type="button" style="font-size: 10px; padding: 1px 4px;" title="Hide Column" onclick="hideColumn(${originalIndex})">×</button>`;
                }
                
                // Set initial visibility based on original index
                if (columnVisibility[originalIndex]) {
                    th.style.display = '';
                } else {
                    th.style.display = 'none';
                }
                
                headerRow.appendChild(th);
            });
            
            console.log('Generated', currentColumnOrder.length, 'table headers in current order');
        }
        
        // Define all available fields from all three data types
        const allAvailableFields = {
            // Core identification
            'ticker_symbol': 'Symbol',
            
            // Dynamic data fields
            'current_candle_open': 'Current Open',
            'current_candle_high': 'Current High',
            'current_candle_low': 'Current Low',
            'current_candle_close': 'Current Close',
            'previous_candle_open': 'Previous Open',
            'previous_candle_high': 'Previous High',
            'previous_candle_low': 'Previous Low',
            'previous_candle_close': 'Previous Close',
            'current_candle_atp': 'Current ATP',
            'previous_candle_atp': 'Previous ATP',
            'last_3_candles_atp': 'Last 3 ATP',
            'prev_swing_high_1': 'Swing High 1',
            'prev_swing_high_2': 'Swing High 2',
            'prev_swing_high_3': 'Swing High 3',
            'prev_swing_low_1': 'Swing Low 1',
            'prev_swing_low_2': 'Swing Low 2',
            'prev_swing_low_3': 'Swing Low 3',
            'bias': 'Bias',
            
            // Indicator fields
            'ema': 'EMA',
            'sma': 'SMA',
            'hma': 'HMA',
            'macd': 'MACD',
            'signal_line': 'Signal Line',
            'supertrend': 'Supertrend',
            'ao': 'AO',
            'keltner_upper': 'Keltner Upper',
            'keltner_middle': 'Keltner Middle',
            'keltner_lower': 'Keltner Lower',
            'pivot': 'Pivot',
            'r1': 'R1',
            's1': 'S1',
            'r2': 'R2',
            's2': 'S2',
            'r3': 'R3',
            's3': 'S3',
            'camarilla_r1': 'Camarilla R1',
            'camarilla_r2': 'Camarilla R2',
            'camarilla_r3': 'Camarilla R3',
            'camarilla_r4': 'Camarilla R4',
            'camarilla_s1': 'Camarilla S1',
            'camarilla_s2': 'Camarilla S2',
            'camarilla_s3': 'Camarilla S3',
            'camarilla_s4': 'Camarilla S4',
            
            // Static data fields - Hourly bars
            'high_low_60_min_bar_9_am_10_am': '60MIN 9-10AM',
            'high_low_60_min_bar_10_am_11_am': '60MIN 10-11AM', 
            'high_low_60_min_bar_11_am_12_pm': '60MIN 11-12PM',
            'high_low_60_min_bar_12_pm_1_pm': '60MIN 12-1PM',
            'high_low_60_min_bar_1_pm_2_pm': '60MIN 1-2PM',
            'high_low_60_min_bar_2_pm_3_pm': '60MIN 2-3PM',
            'high_low_60_min_bar_3_pm_4_pm': '60MIN 3-4PM',
            
            // 30-minute data
            'current_day_30_mins_top_with_date_and_time_of_the_bar': 'Current Day 30MIN Top',
            'current_day_30_mins_bottom_with_date_and_time_of_the_bar': 'Current Day 30MIN Bottom',
            'last_5_tops_in_30_mins_with_date_and_time_of_the_bar': 'Last 5 Tops 30MIN',
            'last_5_bottoms_in_30_mins_with_date_and_time_of_the_bar': 'Last 5 Bottoms 30MIN',
            
            // Daily data
            'day_top_latest_1_with_date': 'Day Top Latest',
            'day_top_previous_1_with_date': 'Day Top Previous-1',
            'day_top_previous_2_with_date': 'Day Top Previous-2',
            'day_bottom_latest_1_with_date': 'Day Bottom Latest',
            'day_bottom_previous_1_with_date': 'Day Bottom Previous-1',
            'day_bottom_previous_2_with_date': 'Day Bottom Previous-2',
            
            // Daily aggregates
            'highest_top_out_of_last_5_daily_tops_with_date': 'Highest 5D Top',
            'highest_top_out_of_last_10_daily_tops_with_date': 'Highest 10D Top',
            'highest_top_out_of_last_20_daily_tops_with_date': 'Highest 20D Top',
            'highest_top_out_of_last_40_daily_tops_with_date': 'Highest 40D Top',
            'lowest_bottom_out_of_last_5_daily_bottoms_with_date': 'Lowest 5D Bottom',
            'lowest_bottom_out_of_last_10_daily_bottoms_with_date': 'Lowest 10D Bottom',
            'lowest_bottom_out_of_last_20_daily_bottoms_with_date': 'Lowest 20D Bottom',
            'lowest_bottom_out_of_last_40_daily_bottoms_with_date': 'Lowest 40D Bottom',
            
            // Daily swing points
            'day_previous_swing_top_1_with_date': 'Day Swing Top 1',
            'day_previous_swing_top_2_with_date': 'Day Swing Top 2',
            'day_previous_swing_top_3_with_date': 'Day Swing Top 3',
            'day_swing_bottom_1_with_date': 'Day Swing Bottom 1',
            'day_previous_swing_bottom_2_with_date': 'Day Swing Bottom 2',
            'day_previous_swing_bottom_3_with_date': 'Day Swing Bottom 3',
            
            // Previous Friday data
            'previous_friday_high': 'Previous Friday High',
            'previous_friday_low': 'Previous Friday Low',
            'previous_friday_close': 'Previous Friday Close',
            
            // Expiry week data
            'expiry_week_open': 'Expiry Week Open',
            'expiry_week_high': 'Expiry Week High',
            'expiry_week_low': 'Expiry Week Low',
            'expiry_week_vwap': 'Expiry Week VWAP',
            'expiry_week_close': 'Expiry Week Close',
            'expiry_week_high_low_volume_bar': 'Expiry Week HLV Bar',
            
            // Rollover week data
            'rollover_week_open': 'Rollover Week Open',
            'rollover_week_high': 'Rollover Week High',
            'rollover_week_low': 'Rollover Week Low',
            'roll_over_week_vwap': 'Rollover Week VWAP',
            'rollover_week_close': 'Rollover Week Close',
            'roll_over_week_high_low_volume_bar': 'Rollover Week HLV Bar',
            
            // Weekly data
            'week_top_latest_1_with_date': 'Week Top Latest',
            'week_top_previous_1_with_date': 'Week Top Previous-1',
            'week_top_previous_2_with_date': 'Week Top Previous-2',
            'highest_top_out_of_last_4_weekly_tops_with_date': 'Highest 4W Top',
            'highest_top_out_of_last_8_weekly_tops_with_date': 'Highest 8W Top',
            'highest_top_out_of_last_12_weekly_tops_with_date': 'Highest 12W Top',
            'highest_top_out_of_last_16_weekly_tops_with_date': 'Highest 16W Top',
            'week_bottom_latest_1_with_date': 'Week Bottom Latest',
            'week_bottom_previous_1_with_date': 'Week Bottom Previous-1',
            'week_bottom_previous_2_with_date': 'Week Bottom Previous-2',
            'lowest_bottom_out_of_last_4_weekly_bottoms_with_date': 'Lowest 4W Bottom',
            'lowest_bottom_out_of_last_8_weekly_bottoms_with_date': 'Lowest 8W Bottom',
            'lowest_bottom_out_of_last_12_weekly_bottoms_with_date': 'Lowest 12W Bottom',
            'lowest_bottom_out_of_last_16_weekly_bottoms_with_date': 'Lowest 16W Bottom',
            
            // Monthly data
            'month_top_1_with_date': 'Month Top 1',
            'month_top_2_with_date': 'Month Top 2',
            'month_top_3_with_date': 'Month Top 3',
            'highest_top_out_of_last_2_monthly_tops_with_date': 'Highest 2M Top',
            'highest_top_out_of_last_4_monthly_tops_with_date': 'Highest 4M Top',
            'highest_top_out_of_last_6_monthly_tops_with_date': 'Highest 6M Top',
            'month_bottom_1_with_date': 'Month Bottom 1',
            'month_bottom_2_with_date': 'Month Bottom 2',
            'month_bottom_3_with_date': 'Month Bottom 3',
            'lowest_bottom_out_of_last_2_monthly_bottoms_with_date': 'Lowest 2M Bottom',
            'lowest_bottom_out_of_last_4_monthly_bottoms_with_date': 'Lowest 4M Bottom',
            'lowest_bottom_out_of_last_6_monthly_bottoms_with_date': 'Lowest 6M Bottom'
        };
        
        // Create mapping from field names to indices
        const fieldNameToIndex = {};
        const fieldNames = Object.keys(allAvailableFields);
        fieldNames.forEach((fieldName, index) => {
            fieldNameToIndex[fieldName] = index;
        });
        
        // Data type categorization for easier management
        const fieldCategories = {
            'dynamic': [
                'current_candle_open', 'current_candle_high', 'current_candle_low', 'current_candle_close',
                'previous_candle_open', 'previous_candle_high', 'previous_candle_low', 'previous_candle_close',
                'current_candle_atp', 'previous_candle_atp', 'last_3_candles_atp',
                'prev_swing_high_1', 'prev_swing_high_2', 'prev_swing_high_3',
                'prev_swing_low_1', 'prev_swing_low_2', 'prev_swing_low_3'
            ],
            'indicators': [
                'ema', 'sma', 'hma', 'macd', 'signal_line', 'supertrend', 'ao',
                'keltner_upper', 'keltner_middle', 'keltner_lower',
                'pivot', 'r1', 's1', 'r2', 's2', 'r3', 's3',
                'camarilla_r1', 'camarilla_r2', 'camarilla_r3', 'camarilla_r4',
                'camarilla_s1', 'camarilla_s2', 'camarilla_s3', 'camarilla_s4'
            ],
            'static': [
                // Hourly bars
                'high_low_60_min_bar_9_am_10_am', 'high_low_60_min_bar_10_am_11_am', 'high_low_60_min_bar_11_am_12_pm',
                'high_low_60_min_bar_12_pm_1_pm', 'high_low_60_min_bar_1_pm_2_pm', 'high_low_60_min_bar_2_pm_3_pm', 'high_low_60_min_bar_3_pm_4_pm',
                
                // 30-minute data
                'current_day_30_mins_top_with_date_and_time_of_the_bar', 'current_day_30_mins_bottom_with_date_and_time_of_the_bar',
                'last_5_tops_in_30_mins_with_date_and_time_of_the_bar', 'last_5_bottoms_in_30_mins_with_date_and_time_of_the_bar',
                
                // Daily data
                'day_top_latest_1_with_date', 'day_top_previous_1_with_date', 'day_top_previous_2_with_date',
                'day_bottom_latest_1_with_date', 'day_bottom_previous_1_with_date', 'day_bottom_previous_2_with_date',
                
                // Daily aggregates
                'highest_top_out_of_last_5_daily_tops_with_date', 'highest_top_out_of_last_10_daily_tops_with_date',
                'highest_top_out_of_last_20_daily_tops_with_date', 'highest_top_out_of_last_40_daily_tops_with_date',
                'lowest_bottom_out_of_last_5_daily_bottoms_with_date', 'lowest_bottom_out_of_last_10_daily_bottoms_with_date',
                'lowest_bottom_out_of_last_20_daily_bottoms_with_date', 'lowest_bottom_out_of_last_40_daily_bottoms_with_date',
                
                // Daily swing points
                'day_previous_swing_top_1_with_date', 'day_previous_swing_top_2_with_date', 'day_previous_swing_top_3_with_date',
                'day_swing_bottom_1_with_date', 'day_previous_swing_bottom_2_with_date', 'day_previous_swing_bottom_3_with_date',
                
                // Previous Friday data
                'previous_friday_high', 'previous_friday_low', 'previous_friday_close',
                
                // Expiry week data
                'expiry_week_open', 'expiry_week_high', 'expiry_week_low', 'expiry_week_vwap', 'expiry_week_close', 'expiry_week_high_low_volume_bar',
                
                // Rollover week data
                'rollover_week_open', 'rollover_week_high', 'rollover_week_low', 'roll_over_week_vwap', 'rollover_week_close', 'roll_over_week_high_low_volume_bar',
                
                // Weekly data
                'week_top_latest_1_with_date', 'week_top_previous_1_with_date', 'week_top_previous_2_with_date',
                'highest_top_out_of_last_4_weekly_tops_with_date', 'highest_top_out_of_last_8_weekly_tops_with_date',
                'highest_top_out_of_last_12_weekly_tops_with_date', 'highest_top_out_of_last_16_weekly_tops_with_date',
                'week_bottom_latest_1_with_date', 'week_bottom_previous_1_with_date', 'week_bottom_previous_2_with_date',
                'lowest_bottom_out_of_last_4_weekly_bottoms_with_date', 'lowest_bottom_out_of_last_8_weekly_bottoms_with_date',
                'lowest_bottom_out_of_last_12_weekly_bottoms_with_date', 'lowest_bottom_out_of_last_16_weekly_bottoms_with_date',
                
                // Monthly data
                'month_top_1_with_date', 'month_top_2_with_date', 'month_top_3_with_date',
                'highest_top_out_of_last_2_monthly_tops_with_date', 'highest_top_out_of_last_4_monthly_tops_with_date', 'highest_top_out_of_last_6_monthly_tops_with_date',
                'month_bottom_1_with_date', 'month_bottom_2_with_date', 'month_bottom_3_with_date',
                'lowest_bottom_out_of_last_2_monthly_bottoms_with_date', 'lowest_bottom_out_of_last_4_monthly_bottoms_with_date', 'lowest_bottom_out_of_last_6_monthly_bottoms_with_date'
            ]
        };

        function updateConnectionStatus(status, text) {
            connectionStatus.textContent = text;
            connectionStatus.className = status === 'connected' ? 'text-success' : 
                                        status === 'error' ? 'text-danger' : 'text-warning';
        }

        function updateLastUpdatedTime() {
            const now = new Date();
            lastUpdated.textContent = now.toLocaleTimeString();
        }

        // Event handlers for + buttons
        function setupIndicatorButtons() {
            // Add event listeners to all + buttons
            document.addEventListener('click', function(e) {
                if (e.target.textContent === '+' && e.target.tagName === 'BUTTON') {
                    e.stopPropagation(); // Prevent any parent event handling
                    
                    const th = e.target.closest('th');
                    const indicatorName = th.textContent.replace('+', '').trim();
                    
                    // Handle different indicators
                    if (indicatorName === 'EMA') {
                        openIndicatorModal('EMA', 'ema', currentConfig.ema);
                    } else if (indicatorName === 'SMA') {
                        openIndicatorModal('SMA', 'sma', currentConfig.sma);
                    } else if (indicatorName === 'HMA') {
                        openIndicatorModal('HMA', 'hma', currentConfig.hma);
                    } else if (indicatorName === 'MACD') {
                        openMacdModal();
                    } else if (indicatorName === 'Supertrend') {
                        openSupertrendModal();
                    } else if (indicatorName.includes('Keltner')) {
                        openKeltnerModal();
                    } else {
                        // For other indicators, show general modal
                        openIndicatorModal(indicatorName, 'general', '');
                    }
                }
            });
            
            // Prevent dragging when clicking on + buttons
            document.addEventListener('mousedown', function(e) {
                if (e.target.textContent === '+' && e.target.tagName === 'BUTTON') {
                    const th = e.target.closest('th');
                    if (th) {
                        th.setAttribute('draggable', 'false');
                    }
                }
            });
            
            document.addEventListener('mouseup', function(e) {
                // Re-enable dragging for all headers
                const headers = document.querySelectorAll('.draggable-header');
                headers.forEach(header => {
                    header.setAttribute('draggable', 'true');
                });
            });
        }

        function openIndicatorModal(name, type, value) {
            currentIndicator = name;
            currentIndicatorType = type;
            document.getElementById('indicatorModalLabel').textContent = `Configure ${name}`;
            document.getElementById('indicatorLabel').textContent = `${name} Period`;
            document.getElementById('indicatorValue').value = value;
            new bootstrap.Modal(document.getElementById('indicatorModal')).show();
        }

        function openMacdModal() {
            const parts = currentConfig.macd.split(',');
            document.getElementById('macdSlow').value = parts[0] || '26';
            document.getElementById('macdFast').value = parts[1] || '12';
            document.getElementById('macdSignal').value = parts[2] || '9';
            new bootstrap.Modal(document.getElementById('macdModal')).show();
        }

        function openSupertrendModal() {
            document.getElementById('supertrendLength').value = currentConfig.supertrendLength;
            document.getElementById('supertrendMultiplier').value = currentConfig.supertrendMultiplier;
            new bootstrap.Modal(document.getElementById('supertrendModal')).show();
        }

        function openKeltnerModal() {
            document.getElementById('keltnerEmaLength').value = currentConfig.keltnerEmaLength;
            document.getElementById('keltnerAtrLength').value = currentConfig.keltnerAtrLength;
            document.getElementById('keltnerMultiplier').value = currentConfig.keltnerMultiplier;
            new bootstrap.Modal(document.getElementById('keltnerModal')).show();
        }

        // Timeframe selection handlers
        function setupTimeframeHandlers() {
            const timeframeOptions = document.querySelectorAll('.timeframe-option');
            const timeframeButton = document.getElementById('timeframeButton');
            
            timeframeOptions.forEach(option => {
                option.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    const timeframe = this.getAttribute('data-timeframe');
                    const displayText = this.getAttribute('data-display');
                    
                    // Update current config
                    currentConfig.timeframe = timeframe;
                    
                    // Update button text
                    timeframeButton.textContent = displayText;
                    
                    // Update active state
                    timeframeOptions.forEach(opt => opt.classList.remove('active'));
                    this.classList.add('active');
                    
                    console.log(`Timeframe changed to: ${timeframe} minutes (${displayText})`);
                    
                    // Reconnect with new timeframe
                    reconnectWithNewConfig();
                });
            });
        }

        // Save button handlers
        function setupModalSaveHandlers() {
            // General indicator save
            document.getElementById('saveIndicator').addEventListener('click', function() {
                const value = document.getElementById('indicatorValue').value;
                if (currentIndicatorType && value) {
                    currentConfig[currentIndicatorType] = value;
                    console.log(`Updated ${currentIndicator} to ${value}`);
                    reconnectWithNewConfig();
                }
                bootstrap.Modal.getInstance(document.getElementById('indicatorModal')).hide();
            });

            // MACD save
            document.getElementById('saveMacd').addEventListener('click', function() {
                const slow = document.getElementById('macdSlow').value;
                const fast = document.getElementById('macdFast').value;
                const signal = document.getElementById('macdSignal').value;
                currentConfig.macd = `${slow},${fast},${signal}`;
                console.log(`Updated MACD to ${currentConfig.macd}`);
                reconnectWithNewConfig();
                bootstrap.Modal.getInstance(document.getElementById('macdModal')).hide();
            });

            // Supertrend save
            document.getElementById('saveSupertrend').addEventListener('click', function() {
                currentConfig.supertrendLength = document.getElementById('supertrendLength').value;
                currentConfig.supertrendMultiplier = document.getElementById('supertrendMultiplier').value;
                console.log(`Updated Supertrend to Length: ${currentConfig.supertrendLength}, Multiplier: ${currentConfig.supertrendMultiplier}`);
                reconnectWithNewConfig();
                bootstrap.Modal.getInstance(document.getElementById('supertrendModal')).hide();
            });

            // Keltner save
            document.getElementById('saveKeltner').addEventListener('click', function() {
                currentConfig.keltnerEmaLength = document.getElementById('keltnerEmaLength').value;
                currentConfig.keltnerAtrLength = document.getElementById('keltnerAtrLength').value;
                currentConfig.keltnerMultiplier = document.getElementById('keltnerMultiplier').value;
                console.log(`Updated Keltner to EMA: ${currentConfig.keltnerEmaLength}, ATR: ${currentConfig.keltnerAtrLength}, Multiplier: ${currentConfig.keltnerMultiplier}`);
                reconnectWithNewConfig();
                bootstrap.Modal.getInstance(document.getElementById('keltnerModal')).hide();
            });

            // Keltner reset
            document.getElementById('resetKeltner').addEventListener('click', function() {
                document.getElementById('keltnerEmaLength').value = '20';
                document.getElementById('keltnerAtrLength').value = '14';
                document.getElementById('keltnerMultiplier').value = '2';
            });
        }

        function reconnectWithNewConfig() {
            console.log('Reconnecting with new configuration:', currentConfig);
            createEventSource();
        }

        // Drag and Drop Functions
        function setupDragAndDrop() {
            const headers = document.querySelectorAll('.draggable-header');
            
            headers.forEach(header => {
                // Remove existing listeners to prevent duplicates
                header.removeEventListener('dragstart', handleDragStart);
                header.removeEventListener('dragover', handleDragOver);
                header.removeEventListener('dragenter', handleDragEnter);
                header.removeEventListener('dragleave', handleDragLeave);
                header.removeEventListener('drop', handleDrop);
                header.removeEventListener('dragend', handleDragEnd);
                
                // Add event listeners
                header.addEventListener('dragstart', handleDragStart);
                header.addEventListener('dragover', handleDragOver);
                header.addEventListener('dragenter', handleDragEnter);
                header.addEventListener('dragleave', handleDragLeave);
                header.addEventListener('drop', handleDrop);
                header.addEventListener('dragend', handleDragEnd);
            });
        }

        function handleDragStart(e) {
            // Find the th element even if the target is a child element (like + button)
            const th = e.target.closest('th');
            if (!th) return;
            
            draggedColumn = {
                visualIndex: parseInt(th.getAttribute('data-column')),
                fieldName: th.getAttribute('data-field'),
                originalIndex: parseInt(th.getAttribute('data-original-index'))
            };
            th.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', th.outerHTML);
            
            console.log('Drag started for column:', draggedColumn);
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        function handleDragEnter(e) {
            const th = e.target.closest('th');
            if (!th) return;
            
            const targetFieldName = th.getAttribute('data-field');
            const targetVisualIndex = parseInt(th.getAttribute('data-column'));
            
            if (targetFieldName !== 'ticker_symbol' && draggedColumn && targetVisualIndex !== draggedColumn.visualIndex) { // Don't allow dropping on Symbol column
                th.classList.add('drag-over');
                console.log('Drag enter on column:', targetFieldName, 'at visual index:', targetVisualIndex);
            }
        }

        function handleDragLeave(e) {
            const th = e.target.closest('th');
            if (th) {
                th.classList.remove('drag-over');
            }
        }

        function handleDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const th = e.target.closest('th');
            if (!th) return false;
            
            const targetFieldName = th.getAttribute('data-field');
            const targetVisualIndex = parseInt(th.getAttribute('data-column'));
            
            // Don't allow dropping on Symbol column
            if (targetFieldName === 'ticker_symbol' || !draggedColumn || draggedColumn.fieldName === 'ticker_symbol') {
                console.log('Drop not allowed on Symbol column');
                return false;
            }
            
            if (draggedColumn.visualIndex !== targetVisualIndex) {
                console.log('Dropping column', draggedColumn.fieldName, 'from position', draggedColumn.visualIndex, 'to position', targetVisualIndex);
                
                // Reorder the currentColumnOrder array
                reorderColumnOrder(draggedColumn.visualIndex, targetVisualIndex);
            }
            
            return false;
        }

        function handleDragEnd(e) {
            const headers = document.querySelectorAll('th');
            headers.forEach(header => {
                header.classList.remove('dragging', 'drag-over');
            });
            draggedColumn = null;
            console.log('Drag ended');
        }

        function reorderColumnOrder(fromIndex, toIndex) {
            // Reorder the currentColumnOrder array
            const newColumnOrder = [...currentColumnOrder];
            const draggedField = newColumnOrder.splice(fromIndex, 1)[0];
            newColumnOrder.splice(toIndex, 0, draggedField);
            
            // Update the current column order
            currentColumnOrder = newColumnOrder;
            
            console.log('Column order updated:', currentColumnOrder);
            
            // Regenerate table headers with new order
            generateTableHeaders();
            
            // Re-setup drag and drop for the new headers
            setupDragAndDrop();
            
            // Update table data with new column order
            if (combinedData.length > 0) {
                updateTable(combinedData);
            }
            
            console.log('Columns reordered. New order:', currentColumnOrder);
        }

        // Column Visibility Functions
        function hideColumn(columnIndex) {
            const fieldName = fieldNames[columnIndex];
            if (fieldName === 'ticker_symbol') {
                alert('Cannot hide the Symbol column');
                return;
            }
            
            columnVisibility[columnIndex] = false;
            updateTableVisibility();
            updateColumnVisibilityModal();
            console.log('Hidden column:', fieldName, 'at index', columnIndex);
        }

        function showColumn(columnIndex) {
            columnVisibility[columnIndex] = true;
            updateTableVisibility();
            updateColumnVisibilityModal();
            console.log('Shown column:', fieldNames[columnIndex], 'at index', columnIndex);
        }

        function updateTableVisibility() {
            // Hide/show header columns based on original index
            const headers = document.querySelectorAll('thead th');
            headers.forEach(header => {
                const originalIndex = parseInt(header.getAttribute('data-original-index'));
                if (columnVisibility[originalIndex]) {
                    header.style.display = '';
                } else {
                    header.style.display = 'none';
                }
            });

            // Update the table body with current combined data if available
            if (combinedData.length > 0) {
                updateTable(combinedData);
            } else {
                // Show loading indicator
                const visibleColumnCount = Object.values(columnVisibility).filter(visible => visible).length;
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="${visibleColumnCount}" class="text-center">
                            <div class="spinner-border text-light spinner-border-sm" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <div class="mt-2">Updating column layout...</div>
                        </td>
                    </tr>
                `;
            }
            
            console.log('Column visibility updated');
        }

        function setupColumnVisibilityModal() {
            const technicalColumns = document.getElementById('technicalColumns');
            const pivotColumns = document.getElementById('pivotColumns');
            
            // Clear existing content
            technicalColumns.innerHTML = '';
            pivotColumns.innerHTML = '';
            
            // Group fields by category using original field order for consistency
            fieldNames.forEach((fieldName, originalIndex) => {
                if (fieldName === 'ticker_symbol') return; // Skip symbol column
                
                const checkbox = createColumnCheckbox(originalIndex, fieldName);
                
                // Categorize fields
                if (fieldCategories.indicators.includes(fieldName) || fieldCategories.dynamic.includes(fieldName)) {
                    technicalColumns.appendChild(checkbox);
                } else if (fieldCategories.static.includes(fieldName)) {
                    pivotColumns.appendChild(checkbox);
                } else {
                    // Default to technical columns for uncategorized fields
                    technicalColumns.appendChild(checkbox);
                }
            });
            
            // Setup modal buttons
            document.getElementById('showAllColumns').addEventListener('click', showAllColumns);
            document.getElementById('hideAllOptional').addEventListener('click', hideAllOptionalColumns);
        }

        function createColumnCheckbox(columnIndex, fieldName) {
            const div = document.createElement('div');
            div.className = 'form-check mb-2';
            
            const checkbox = document.createElement('input');
            checkbox.className = 'form-check-input';
            checkbox.type = 'checkbox';
            checkbox.id = `column-${columnIndex}`;
            checkbox.checked = columnVisibility[columnIndex];
            checkbox.addEventListener('change', function() {
                if (this.checked) {
                    showColumn(columnIndex);
                } else {
                    hideColumn(columnIndex);
                }
            });
            
            const label = document.createElement('label');
            label.className = 'form-check-label text-light';
            label.setAttribute('for', `column-${columnIndex}`);
            label.textContent = allAvailableFields[fieldName];
            
            div.appendChild(checkbox);
            div.appendChild(label);
            
            return div;
        }

        function updateColumnVisibilityModal() {
            Object.keys(columnVisibility).forEach(columnIndex => {
                const checkbox = document.getElementById(`column-${columnIndex}`);
                if (checkbox) {
                    checkbox.checked = columnVisibility[columnIndex];
                }
            });
        }

        function showAllColumns() {
            Object.keys(columnVisibility).forEach(index => {
                columnVisibility[index] = true;
            });
            updateTableVisibility();
            updateColumnVisibilityModal();
            console.log('All columns shown');
        }

        function hideAllOptionalColumns() {
            // Hide all except essential columns
            const essentialColumns = [
                'ticker_symbol', 'current_candle_close', 'bias', 'ema', 'sma', 'macd', 'supertrend',
                'pivot', 'r1', 's1'
            ];
            
            fieldNames.forEach((fieldName, originalIndex) => {
                columnVisibility[originalIndex] = essentialColumns.includes(fieldName);
            });
            
            updateTableVisibility();
            updateColumnVisibilityModal();
            console.log('Hidden all optional columns');
        }

        // Make hideColumn available globally for onclick handlers
        window.hideColumn = hideColumn;

        function createEventSource() {
            if (eventSource) {
                eventSource.close();
            }

            // Set status to connecting as soon as we try to connect
            updateConnectionStatus('connecting', 'Connecting...');

            // Clear any previous disconnect timer
            if (disconnectTimeout) clearTimeout(disconnectTimeout);

            const queryParams = new URLSearchParams({
                data_types: 'dynamic,static,indicators',
                timeframe: currentConfig.timeframe,
                ema: currentConfig.ema,
                sma: currentConfig.sma,
                hma: currentConfig.hma,
                macd: currentConfig.macd,
                supertrendLength: currentConfig.supertrendLength,
                supertrendMultiplier: currentConfig.supertrendMultiplier,
                keltnerEmaLength: currentConfig.keltnerEmaLength,
                keltnerAtrLength: currentConfig.keltnerAtrLength,
                keltnerMultiplier: currentConfig.keltnerMultiplier
            });

            console.log('Connecting to unified SSE stream with parameters:', queryParams.toString());
            eventSource = new EventSource(`{% url "unified_sse_stream" %}?${queryParams.toString()}`);

            eventSource.onopen = function() {
                console.log('SSE connection opened');
                isConnected = true;
                updateConnectionStatus('connected', 'Connected');
            };

            eventSource.onerror = function(error) {
                console.error('SSE connection error:', error);
                isConnected = false;
                updateConnectionStatus('connecting', 'Connecting...');
                // Auto-reconnect after 5 seconds
                setTimeout(() => {
                    if (!isConnected) {
                        console.log('Attempting to reconnect...');
                        createEventSource();
                    }
                }, 5000);
            };

            eventSource.onmessage = function(event) {
                try {
                    const response = JSON.parse(event.data);
                    console.log('Received unified stream response:', response);
                    
                    // Handle different message types from unified stream
                    if (response.type === 'dynamic') {
                        console.log('Processing dynamic data:', response.data);
                        console.log('Processing time:', response.processing_time, 'seconds');
                        storeDynamicData(response.data);
                        mergeCombinedData();
                    } else if (response.type === 'static') {
                        console.log('Processing static data:', response.data);
                        console.log('Processing time:', response.processing_time, 'seconds');
                        storeStaticData(response.data);
                        mergeCombinedData();
                    } else if (response.type === 'indicators') {
                        console.log('Processing indicators data:', response.data);
                        console.log('Processing time:', response.processing_time, 'seconds');
                        storeIndicatorData(response.data);
                        mergeCombinedData();
                    } else if (response.type === 'error') {
                        console.error('Error from unified stream:', response.error);
                        updateConnectionStatus('error', `Error: ${response.error}`);
                    }
                    
                    // Update connection status and timers for any successful data
                    if (response.type !== 'error') {
                        updateLastUpdatedTime();
                        if (disconnectTimeout) clearTimeout(disconnectTimeout);
                        updateConnectionStatus('connected', 'Connected');
                        disconnectTimeout = setTimeout(function() {
                            updateConnectionStatus('error', 'Disconnected');
                        }, DISCONNECT_DELAY);
                    }
                } catch (error) {
                    console.error('Error parsing unified SSE data:', error);
                }
            };
        }

        // Functions to store and merge data from different streams
        function storeDynamicData(data) {
            if (Array.isArray(data)) {
                data.forEach(ticker => {
                    const symbol = ticker.ticker_symbol;
                    if (symbol) {
                        if (!latestData.dynamic[symbol]) {
                            latestData.dynamic[symbol] = {};
                        }
                        Object.assign(latestData.dynamic[symbol], ticker);
                    }
                });
            }
        }

        function storeStaticData(data) {
            if (Array.isArray(data)) {
                data.forEach(ticker => {
                    const symbol = ticker.ticker_symbol;
                    if (symbol) {
                        if (!latestData.static[symbol]) {
                            latestData.static[symbol] = {};
                        }
                        Object.assign(latestData.static[symbol], ticker);
                    }
                });
            }
        }

        function storeIndicatorData(data) {
            if (Array.isArray(data)) {
                data.forEach(ticker => {
                    const symbol = ticker.ticker_symbol;
                    if (symbol) {
                        if (!latestData.indicators[symbol]) {
                            latestData.indicators[symbol] = {};
                        }
                        Object.assign(latestData.indicators[symbol], ticker);
                    }
                });
            }
        }

        function mergeCombinedData() {
            combinedData = [];
            
            // Get all unique ticker symbols from all data types
            const allSymbols = new Set();
            ['dynamic', 'static', 'indicators'].forEach(dataType => {
                Object.keys(latestData[dataType]).forEach(symbol => allSymbols.add(symbol));
            });
            
            // Merge data for each symbol
            allSymbols.forEach(symbol => {
                const mergedTicker = {
                    ticker_symbol: symbol,
                    ...latestData.dynamic[symbol] || {},
                    ...latestData.static[symbol] || {},
                    ...latestData.indicators[symbol] || {}
                };
                combinedData.push(mergedTicker);
            });
            
            // Update the table with merged data
            updateTable(combinedData);
            console.log('Merged data for', allSymbols.size, 'symbols with', Object.keys(allAvailableFields).length, 'potential fields');
        }

                function updateTable(data) {
            // Clear existing rows
            tableBody.innerHTML = '';

            // Count visible columns for colspan
            const visibleColumnCount = Object.values(columnVisibility).filter(visible => visible).length;

            if (data.message) {
                tableBody.innerHTML = `<tr><td colspan="${visibleColumnCount}" class="text-center text-warning">${data.message}</td></tr>`;
                return;
            }

            if (!Array.isArray(data) || data.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="${visibleColumnCount}" class="text-center text-muted">No data available</td></tr>`;
                return;
            }

            data.forEach(ticker => {
                const row = document.createElement('tr');
                
                // Iterate through current column order and create cells for visible columns
                currentColumnOrder.forEach((fieldName) => {
                    const originalIndex = fieldNameToIndex[fieldName];
                    if (!columnVisibility[originalIndex]) return; // Skip hidden columns
                    
                    const cell = document.createElement('td');
                    
                    // Handle Symbol column
                    if (fieldName === 'ticker_symbol') {
                        cell.className = 'position-sticky start-0 bg-dark fw-bold';
                        cell.textContent = ticker[fieldName] || '-';
                    } else {
                        const value = ticker[fieldName];
                        
                        if (typeof value === 'number') {
                            cell.textContent = value.toFixed(2);
                            
                            // Add color coding based on field name
                            if (fieldName === 'signal_line' || fieldName === 'ao') {
                                cell.className = value > 0 ? 'text-success' : 'text-danger';
                            }
                        } else {
                            cell.textContent = value || '-';
                            
                            // Special handling for bias column
                            if (fieldName === 'bias') {
                                if (value === 'BULLISH') {
                                    cell.className = 'text-success fw-bold';
                                } else if (value === 'BEARISH') {
                                    cell.className = 'text-danger fw-bold';
                                } else {
                                    cell.className = 'text-warning';
                                }
                            }
                        }
                    }
                    
                    row.appendChild(cell);
                });

                tableBody.appendChild(row);
            });
            
            console.log(`Table updated with ${visibleColumnCount} visible columns for ${data.length} tickers in current order`);
        }

        // Initialize connection when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize the new column structure
            initializeColumnVisibility();
            generateTableHeaders();
            
            setupIndicatorButtons();
            setupModalSaveHandlers();
            setupTimeframeHandlers();
            setupDragAndDrop();
            setupColumnVisibilityModal();
            createEventSource();
        });

        // Handle page visibility changes to manage connection
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                console.log('Page hidden, maintaining connection');
            } else {
                console.log('Page visible');
                if (!isConnected) {
                    createEventSource();
                }
            }
        });

        // Clean up connection when page unloads
        window.addEventListener('beforeunload', function() {
            if (eventSource) {
                eventSource.close();
            }
        });
    </script>
</div>
{% endblock %}
