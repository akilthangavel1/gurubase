<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Future Dynamic Data</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        body {
            background-color: #212529;
            color: #e9ecef;
        }

        .table {
            color: #e9ecef;
        }

        .modal-content {
            background-color: #343a40;
            color: #e9ecef;
        }

        .form-control,
        .form-select,
        .input-group-text {
            background-color: #343a40;
            border-color: #495057;
            color: #e9ecef;
        }

        .form-control:focus,
        .form-select:focus {
            background-color: #3b4148;
            color: #e9ecef;
        }

        .badge.bg-light {
            background-color: #343a40 !important;
            color: #e9ecef !important;
        }

        .btn-light {
            background-color: #343a40;
            border-color: #495057;
            color: #e9ecef;
        }

        .btn-outline-primary {
            color: #8bb9fe;
            border-color: #0d6efd;
        }

        .table-striped>tbody>tr:nth-of-type(odd)>* {
            color: #e9ecef;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <div class="row">
            <div class="col-12">
                <h1 class="mb-4 text-light">Future Dynamic Data</h1>
                <div class="card bg-dark mb-4">
                    <div class="card-body">
                        <div class="input-group">
                            <label class="input-group-text" for="timeframe">Timeframe:</label>
                            <select class="form-select" id="timeframe">
                                <option value="1">1 Minute</option>
                                <option value="5">5 Minutes</option>
                                <option value="15">15 Minutes</option>
                                <option value="30">30 Minutes</option>
                                <option value="60">1 Hour</option>
                                <option value="240">4 Hours</option>
                                <option value="1440">1 Day</option>
                            </select>
                            <button class="btn btn-primary" id="updateTimeframe">Update</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-12">
                <div id="data-container">
                    <!-- Last Updated Information -->
                    <div class="d-flex align-items-center justify-content-between mb-3">
                        <div class="text-muted small">
                            <span class="badge bg-dark text-light p-2">
                                <i class="bi bi-clock"></i> Last Updated: <span id="lastUpdatedTime">Loading...</span>
                            </span>
                        </div>
                        <div>
                            <span class="badge bg-primary" id="recordCount">0 records</span>
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table id="dynamicDataTable" class="table table-bordered table-striped table-dark">
                            <thead class="table-dark">
                                <tr>
                                    <th rowspan="2">Ticker</th>
                                    <th colspan="4" class="text-center">Current Candle</th>
                                    <th colspan="4" class="text-center">Previous Candle</th>
                                    <th colspan="3" class="text-center">ATP Values</th>
                                    <th colspan="3" class="text-center">Swing Highs</th>
                                    <th colspan="3" class="text-center">Swing Lows</th>
                                    <th rowspan="2">Bias</th>
                                </tr>
                                <tr>
                                    <th>Open</th>
                                    <th>High</th>
                                    <th>Low</th>
                                    <th>Close</th>
                                    <th>Open</th>
                                    <th>High</th>
                                    <th>Low</th>
                                    <th>Close</th>
                                    <th>Current</th>
                                    <th>Previous</th>
                                    <th>Last 3</th>
                                    <th>1</th>
                                    <th>2</th>
                                    <th>3</th>
                                    <th>1</th>
                                    <th>2</th>
                                    <th>3</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Data will be populated via JavaScript -->
                            </tbody>
                        </table>
                    </div>
                    <div id="loading-indicator" class="alert alert-info text-center">
                        <div class="spinner-border text-primary me-2" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        Loading data...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
    <script>
        const dataContainer = document.getElementById('data-container');
        const timeframeSelect = document.getElementById('timeframe');
        const updateButton = document.getElementById('updateTimeframe');
        const loadingIndicator = document.getElementById('loading-indicator');
        const tableContainer = document.querySelector('.table-responsive');
        const lastUpdatedTime = document.getElementById('lastUpdatedTime');
        const recordCount = document.getElementById('recordCount');

        let eventSource;

        // Initially hide the table until data loads
        tableContainer.style.display = 'none';

        function updateLastUpdatedTime() {
            const now = new Date();
            lastUpdatedTime.textContent = now.toLocaleString();
        }

        function createEventSource(timeframe) {
            if (eventSource) {
                console.log('Closing existing EventSource');
                eventSource.close();
            }
            
            // Show loading indicator
            loadingIndicator.style.display = 'block';
            tableContainer.style.display = 'none';
            
            console.log('Creating new EventSource with timeframe:', timeframe);
            const newEventSource = new EventSource(`{% url "sse_dynamic_data" %}?timeframe=${timeframe}`);
            
            newEventSource.onopen = () => console.log('EventSource connection opened with timeframe:', timeframe);
            
            newEventSource.onerror = (error) => {
                console.error('EventSource error:', error);
                loadingIndicator.innerHTML = '<div class="alert alert-danger">Error connecting to the server. Please try again later.</div>';
            };
            
            newEventSource.onmessage = function(event) {
                // Hide loading indicator and show table
                loadingIndicator.style.display = 'none';
                tableContainer.style.display = 'block';
                
                const data = JSON.parse(event.data);
                const tableBody = document.querySelector('#dynamicDataTable tbody');

                while (tableBody.firstChild) {
                    tableBody.removeChild(tableBody.firstChild);
                }

                if (data.message) {
                    loadingIndicator.innerHTML = `<div class="alert alert-warning">${data.message}</div>`;
                    loadingIndicator.style.display = 'block';
                    tableContainer.style.display = 'none';
                } else {
                    updateLastUpdatedTime();
                    recordCount.textContent = `${data.length} records`;
                    
                    data.forEach(ticker => {
                        const row = document.createElement('tr');
                        
                        // Ticker cell
                        const tickerCell = document.createElement('td');
                        tickerCell.textContent = ticker.ticker_symbol;
                        tickerCell.classList.add('fw-bold');
                        row.appendChild(tickerCell);
                        
                        // Create cells for all data points
                        const values = [
                            // Current candle group
                            ticker.current_candle_open,
                            ticker.current_candle_high,
                            ticker.current_candle_low,
                            ticker.current_candle_close,
                            
                            // Previous candle group
                            ticker.previous_candle_open,
                            ticker.previous_candle_high,
                            ticker.previous_candle_low,
                            ticker.previous_candle_close,
                            
                            // ATP values group
                            ticker.current_candle_atp,
                            ticker.previous_candle_atp,
                            ticker.last_3_candles_atp,
                            
                            // Swing highs group
                            ticker.prev_swing_high_1,
                            ticker.prev_swing_high_2,
                            ticker.prev_swing_high_3,
                            
                            // Swing lows group
                            ticker.prev_swing_low_1,
                            ticker.prev_swing_low_2,
                            ticker.prev_swing_low_3,
                        ];
                        
                        values.forEach(value => {
                            const cell = document.createElement('td');
                            
                            if (typeof value === 'number') {
                                cell.textContent = value.toFixed(2);
                            } else {
                                cell.textContent = value || '-';
                            }
                            row.appendChild(cell);
                        });
                        
                        // Add bias cell
                        const biasCell = document.createElement('td');
                        biasCell.textContent = ticker.bias || 'NEUTRAL';
                        
                        // Add color based on bias
                        if (ticker.bias === 'BULLISH') {
                            biasCell.classList.add('text-success', 'fw-bold');
                        } else if (ticker.bias === 'BEARISH') {
                            biasCell.classList.add('text-danger', 'fw-bold');
                        } else {
                            biasCell.classList.add('text-warning');
                        }
                        
                        row.appendChild(biasCell);
                        
                        tableBody.appendChild(row);
                    });
                }
            };
            return newEventSource;
        }

        // Initialize EventSource
        eventSource = createEventSource(timeframeSelect.value);

        // Update EventSource when timeframe changes
        updateButton.addEventListener('click', function() {
            eventSource = createEventSource(timeframeSelect.value);
        });
    </script>
</body>
</html>